import{j as e,c as Ct,i as Lt,u as Mt}from"./vendor-data-BYhqPCcD.js";import{r as a}from"./vendor-react-CfDhA8Yr.js";import{R as Tt,P as zt,C as Ze,a as Pt,T as Je,O as Qe,D as et,b as Et,V as _t,c as tt,I as Dt,d as It,e as st,f as Vt,g as nt,h as Ot,i as $t,j as at,k as rt,L as lt,l as it,m as At,n as ot,o as ct,p as dt}from"./vendor-radix-BeDz-D1T.js";import{c as Z,B as A,p as Ft}from"./index-xpQrH_iz.js";import{X as ut,s as ft,u as Wt,v as Ut,H as Bt,w as Kt,x as Ht,T as Oe,y as qt,z as Gt,E as Yt,G as Xt,I as Zt,B as Ke,J as Jt,K as Qt,L as Ve,C as es,h as ts,N as ss,O as ns,Q as as,R as rs,o as ls,A as is,j as mt,V as os,W as cs,Y as ds,_ as He,$ as us,a0 as fs,a1 as ms}from"./vendor-utils-E_de3sau.js";import{f as Te,o as ze,g as Pe}from"./vendor-charts-BXvgwH96.js";import{I as hs}from"./format-B0kU3Ifh.js";const xs=Tt,gs=zt,ht=a.forwardRef(({className:t,...n},r)=>e.jsx(Qe,{ref:r,className:Z("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...n}));ht.displayName=Qe.displayName;const xt=a.forwardRef(({className:t,children:n,...r},i)=>e.jsxs(gs,{children:[e.jsx(ht,{}),e.jsxs(Ze,{ref:i,className:Z("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...r,children:[n,e.jsxs(Pt,{className:"absolute right-3 top-3 rounded-md p-1.5 text-muted-foreground/80 transition-all duration-200 hover:bg-muted hover:text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none z-50",children:[e.jsx(ut,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"é—œé–‰"})]})]})]}));xt.displayName=Ze.displayName;const gt=({className:t,...n})=>e.jsx("div",{className:Z("flex flex-col space-y-1.5 text-center sm:text-left",t),...n});gt.displayName="DialogHeader";const pt=a.forwardRef(({className:t,...n},r)=>e.jsx(Je,{ref:r,className:Z("text-lg font-semibold leading-none tracking-tight",t),...n}));pt.displayName=Je.displayName;const ps=a.forwardRef(({className:t,...n},r)=>e.jsx(et,{ref:r,className:Z("text-sm text-muted-foreground",t),...n}));ps.displayName=et.displayName;const bs=Et,vs=_t,bt=a.forwardRef(({className:t,children:n,...r},i)=>e.jsxs(tt,{ref:i,className:Z("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",t),...r,children:[n,e.jsx(Dt,{asChild:!0,children:e.jsx(ft,{className:"h-4 w-4 opacity-50"})})]}));bt.displayName=tt.displayName;const vt=a.forwardRef(({className:t,...n},r)=>e.jsx(at,{ref:r,className:Z("flex cursor-default items-center justify-center py-1",t),...n,children:e.jsx(Ut,{className:"h-4 w-4"})}));vt.displayName=at.displayName;const yt=a.forwardRef(({className:t,...n},r)=>e.jsx(rt,{ref:r,className:Z("flex cursor-default items-center justify-center py-1",t),...n,children:e.jsx(ft,{className:"h-4 w-4"})}));yt.displayName=rt.displayName;const wt=a.forwardRef(({className:t,children:n,position:r="popper",...i},c)=>e.jsx(It,{children:e.jsxs(st,{ref:c,className:Z("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:r,...i,children:[e.jsx(vt,{}),e.jsx(Vt,{className:Z("p-1",r==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:n}),e.jsx(yt,{})]})}));wt.displayName=st.displayName;const ys=a.forwardRef(({className:t,...n},r)=>e.jsx(lt,{ref:r,className:Z("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...n}));ys.displayName=lt.displayName;const jt=a.forwardRef(({className:t,children:n,...r},i)=>e.jsxs(nt,{ref:i,className:Z("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ot,{children:e.jsx(Wt,{className:"h-4 w-4"})})}),e.jsx($t,{children:n})]}));jt.displayName=nt.displayName;const ws=a.forwardRef(({className:t,...n},r)=>e.jsx(it,{ref:r,className:Z("-mx-1 my-1 h-px bg-muted",t),...n}));ws.displayName=it.displayName;const js=At,Nt=a.forwardRef(({className:t,...n},r)=>e.jsx(ot,{ref:r,className:Z("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",t),...n}));Nt.displayName=ot.displayName;const Le=a.forwardRef(({className:t,...n},r)=>e.jsx(ct,{ref:r,className:Z("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",t),...n}));Le.displayName=ct.displayName;const Me=a.forwardRef(({className:t,...n},r)=>e.jsx(dt,{ref:r,className:Z("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...n}));Me.displayName=dt.displayName;const _e="#ef5350",De="#26a69a",Re={ma5:"#ffc107",ma10:"#9c27b0",ma20:"#2196f3",ma60:"#ff9800",ma120:"#9e9e9e"},Ie={upper:"#e91e63",middle:"#ffc107",lower:"#4caf50"};function Ns(t){return t.filter(n=>n.open!=null&&n.high!=null&&n.low!=null&&n.close!=null).map(n=>({time:n.date,open:n.open,high:n.high,low:n.low,close:n.close}))}function ke(t,n){return t.filter(r=>r[n]!=null&&typeof r[n]=="number").map(r=>({time:r.date,value:r[n]}))}function Ss({data:t,height:n=400,showBollinger:r=!1,visibleMAs:i={ma5:!0,ma10:!0,ma20:!0,ma60:!0,ma120:!1},onChartReady:c,onCrosshairMove:v,onChartClick:m}){const p=a.useRef(null),f=a.useRef(null),C=a.useRef(t),S=a.useRef({});return a.useEffect(()=>{if(!p.current)return;const h=Te(p.current,{width:p.current.clientWidth,height:n,layout:{background:{type:Pe.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:ze.Normal,vertLine:{width:1,color:"rgba(0, 0, 0, 0.3)",style:3},horzLine:{width:1,color:"rgba(0, 0, 0, 0.3)",style:3}},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",timeVisible:!0,secondsVisible:!1,rightOffset:0,barSpacing:8,minBarSpacing:2,fixLeftEdge:!1,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0,rightBarStaysOnScroll:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});f.current=h;const M=h.addCandlestickSeries({upColor:_e,downColor:De,borderUpColor:_e,borderDownColor:De,wickUpColor:_e,wickDownColor:De});S.current.candlestick=M,S.current.ma5=h.addLineSeries({color:Re.ma5,lineWidth:1,visible:i.ma5!==!1,lastValueVisible:!1,priceLineVisible:!1}),S.current.ma10=h.addLineSeries({color:Re.ma10,lineWidth:1,visible:i.ma10!==!1,lastValueVisible:!1,priceLineVisible:!1}),S.current.ma20=h.addLineSeries({color:Re.ma20,lineWidth:1,visible:i.ma20!==!1,lastValueVisible:!1,priceLineVisible:!1}),S.current.ma60=h.addLineSeries({color:Re.ma60,lineWidth:1,visible:i.ma60!==!1,lastValueVisible:!1,priceLineVisible:!1}),S.current.ma120=h.addLineSeries({color:Re.ma120,lineWidth:1,visible:i.ma120===!0,lastValueVisible:!1,priceLineVisible:!1}),S.current.bbUpper=h.addLineSeries({color:Ie.upper,lineWidth:1,lineStyle:2,title:"BB Upper",visible:r}),S.current.bbMiddle=h.addLineSeries({color:Ie.middle,lineWidth:1,title:"BB Middle",visible:r}),S.current.bbLower=h.addLineSeries({color:Ie.lower,lineWidth:1,lineStyle:2,title:"BB Lower",visible:r});const V=new ResizeObserver(E=>{if(!h||E.length===0||E[0].target!==p.current)return;const L=E[0].contentRect;h.applyOptions({width:L.width,height:L.height})});return V.observe(p.current),v&&h.subscribeCrosshairMove(E=>{if(!E.time||!E.point){v(null);return}const L=E.time,x=C.current.find(z=>z.date===L);x&&v({date:x.date,open:x.open,high:x.high,low:x.low,close:x.close,volume:x.volume,ma5:x.ma5,ma10:x.ma10,ma20:x.ma20,ma60:x.ma60,ma120:x.ma120})}),h.subscribeClick(E=>{if(!E.time||!E.point)return;const L=E.time,x=C.current.find(z=>z.date===L);x&&m&&m({date:x.date,open:x.open,high:x.high,low:x.low,close:x.close,volume:x.volume,ma5:x.ma5,ma10:x.ma10,ma20:x.ma20,ma60:x.ma60,ma120:x.ma120})}),c&&c(h,M),()=>{V.disconnect(),h.remove(),f.current=null}},[]),a.useEffect(()=>{!f.current||!p.current||f.current.applyOptions({width:p.current.clientWidth,height:n})},[n]),a.useEffect(()=>{if(!f.current||!t||t.length===0)return;C.current=t;const h=S.current;h.candlestick&&h.candlestick.setData(Ns(t));const{ma5:M,ma10:V,ma20:E,ma60:L,ma120:x}=S.current;M&&M.setData(ke(t,"ma5")),V&&V.setData(ke(t,"ma10")),E&&E.setData(ke(t,"ma20")),L&&L.setData(ke(t,"ma60")),x&&x.setData(ke(t,"ma120")),h.bbUpper&&h.bbUpper.setData(ke(t,"bb_upper")),h.bbMiddle&&h.bbMiddle.setData(ke(t,"bb_middle")),h.bbLower&&h.bbLower.setData(ke(t,"bb_lower"))},[t,f.current]),a.useEffect(()=>{const h=S.current;h.ma5&&h.ma5.applyOptions({visible:i.ma5!==!1}),h.ma10&&h.ma10.applyOptions({visible:i.ma10!==!1}),h.ma20&&h.ma20.applyOptions({visible:i.ma20!==!1}),h.ma60&&h.ma60.applyOptions({visible:i.ma60!==!1}),h.ma120&&h.ma120.applyOptions({visible:i.ma120===!0})},[i]),a.useEffect(()=>{const h=S.current;h.bbUpper&&h.bbUpper.applyOptions({visible:r}),h.bbMiddle&&h.bbMiddle.applyOptions({visible:r}),h.bbLower&&h.bbLower.applyOptions({visible:r})},[r]),e.jsx("div",{ref:p,className:"w-full",style:{height:`${n}px`}})}const ks="rgba(239, 83, 80, 0.6)",Rs="rgba(38, 166, 154, 0.6)";function Cs({data:t,height:n=120,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef({});return a.useEffect(()=>{if(!i.current)return;const m=Te(i.current,{width:i.current.clientWidth,height:n,layout:{background:{type:Pe.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:ze.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.1,bottom:0}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current.volume=m.addHistogramSeries({priceFormat:{type:"volume"},priceScaleId:"right"}),v.current.volumeMa5=m.addLineSeries({color:"#ff9800",lineWidth:1,lineStyle:2,priceScaleId:"right"});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const C=f[0].contentRect;m.applyOptions({width:C.width,height:C.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,n)},[n]),a.useEffect(()=>{if(!t||t.length===0)return;const m=v.current;if(m.volume){const p=t.map(f=>({time:f.date,value:f.volume||0,color:(f.close||0)>=(f.open||0)?ks:Rs}));m.volume.setData(p)}if(m.volumeMa5){const p=t.filter(f=>f.volume_ma5!=null).map(f=>({time:f.date,value:f.volume_ma5}));m.volumeMa5.setData(p)}},[t]),e.jsx("div",{ref:i,className:"w-full",style:{height:`${n}px`}})}function qe({data:t,height:n=200,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef({});return a.useEffect(()=>{if(!i.current)return;const m=Te(i.current,{width:i.current.clientWidth,height:n,layout:{background:{type:Pe.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:ze.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current.histogram=m.addHistogramSeries({priceFormat:{type:"price",precision:4,minMove:1e-4},priceScaleId:"right"}),v.current.macd=m.addLineSeries({color:"#2196f3",lineWidth:2,priceScaleId:"right"}),v.current.signal=m.addLineSeries({color:"#ff9800",lineWidth:2,priceScaleId:"right"});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const C=f[0].contentRect;m.applyOptions({width:C.width,height:C.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,n)},[n]),a.useEffect(()=>{if(!t||t.length===0)return;const m=v.current;if(m.histogram){const p=t.filter(f=>f.macd_hist!=null).map(f=>({time:f.date,value:f.macd_hist,color:(f.macd_hist||0)>=0?"#ef5350":"#26a69a"}));m.histogram.setData(p)}if(m.macd){const p=t.filter(f=>f.macd!=null).map(f=>({time:f.date,value:f.macd}));m.macd.setData(p)}if(m.signal){const p=t.filter(f=>f.macd_signal!=null).map(f=>({time:f.date,value:f.macd_signal}));m.signal.setData(p)}},[t]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1 text-xs border-b",children:[e.jsx("span",{className:"font-medium",children:"MACD (12, 26, 9)"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#2196f3"},children:"â—"})," MACD"]}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#ff9800"},children:"â—"})," Signal"]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-red-500",children:"â– "}),"/",e.jsx("span",{className:"text-green-500",children:"â– "})," Histogram"]})]}),e.jsx("div",{ref:i,className:"w-full",style:{height:`${n}px`}})]})}function Ge({data:t,height:n=200,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef({});return a.useEffect(()=>{if(!i.current)return;const m=Te(i.current,{width:i.current.clientWidth,height:n,layout:{background:{type:Pe.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:ze.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current.kLine=m.addLineSeries({color:"#2196f3",lineWidth:2,priceScaleId:"right"}),v.current.dLine=m.addLineSeries({color:"#ff9800",lineWidth:2,priceScaleId:"right"}),m.priceScale("right").applyOptions({autoScale:!1,scaleMargins:{top:0,bottom:0}});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const C=f[0].contentRect;m.applyOptions({width:C.width,height:C.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,n)},[n]),a.useEffect(()=>{if(!t||t.length===0)return;const m=v.current;if(m.kLine){const p=t.filter(f=>f.k!=null).map(f=>({time:f.date,value:f.k}));m.kLine.setData(p)}if(m.dLine){const p=t.filter(f=>f.d!=null).map(f=>({time:f.date,value:f.d}));m.dLine.setData(p)}},[t]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1 text-xs border-b",children:[e.jsx("span",{className:"font-medium",children:"KD éš¨æ©ŸæŒ‡æ¨™ (9, 3, 3)"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#2196f3"},children:"â—"})," Kå€¼"]}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#ff9800"},children:"â—"})," Då€¼"]}),e.jsx("span",{className:"text-muted-foreground",children:"è¶…è²· 80+ / è¶…è³£ 20-"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{top:"5%",height:"20%",backgroundColor:"rgba(239, 83, 80, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{bottom:"5%",height:"20%",backgroundColor:"rgba(38, 166, 154, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute right-2 text-[10px] text-red-400 pointer-events-none",style:{top:"15%"},children:"80"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-muted-foreground pointer-events-none",style:{top:"45%"},children:"50"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-green-400 pointer-events-none",style:{bottom:"15%"},children:"20"}),e.jsx("div",{ref:i,className:"w-full relative",style:{height:`${n}px`,zIndex:2}})]})]})}function Ye({data:t,height:n=180,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef(null);return a.useEffect(()=>{if(!i.current)return;const m=Te(i.current,{width:i.current.clientWidth,height:n,layout:{background:{type:Pe.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:ze.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current=m.addLineSeries({color:"#9c27b0",lineWidth:2,priceScaleId:"right"}),m.priceScale("right").applyOptions({autoScale:!1,scaleMargins:{top:0,bottom:0}});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const C=f[0].contentRect;m.applyOptions({width:C.width,height:C.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,n)},[n]),a.useEffect(()=>{if(!t||t.length===0||!v.current)return;const m=t.filter(p=>p.rsi!=null).map(p=>({time:p.date,value:p.rsi}));v.current.setData(m)},[t]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1 text-xs border-b",children:[e.jsx("span",{className:"font-medium",children:"RSI ç›¸å°å¼·å¼±æŒ‡æ¨™ (14)"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#9c27b0"},children:"â—"})," RSI"]}),e.jsx("span",{className:"text-muted-foreground",children:"è¶…è²· 70+ / è¶…è³£ 30-"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{top:"5%",height:"30%",backgroundColor:"rgba(239, 83, 80, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{bottom:"5%",height:"30%",backgroundColor:"rgba(38, 166, 154, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute right-2 text-[10px] text-red-400 pointer-events-none",style:{top:"20%"},children:"70"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-muted-foreground pointer-events-none",style:{top:"45%"},children:"50"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-green-400 pointer-events-none",style:{bottom:"20%"},children:"30"}),e.jsx("div",{ref:i,className:"w-full relative",style:{height:`${n}px`,zIndex:2}})]})]})}const Ls=[{type:"trendline",label:"è¶¨å‹¢ç·š",icon:e.jsx(Oe,{className:"h-3.5 w-3.5"})},{type:"segment",label:"ç·šæ®µ",icon:e.jsx(qt,{className:"h-3.5 w-3.5"})},{type:"ray",label:"å°„ç·š",icon:e.jsx(Gt,{className:"h-3.5 w-3.5"})},{type:"horizontal",label:"æ°´å¹³",icon:e.jsx(Yt,{className:"h-3.5 w-3.5"})},{type:"vertical",label:"åž‚ç›´",icon:e.jsx(Xt,{className:"h-3.5 w-3.5"})},{type:"parallel",label:"é€šé“",icon:e.jsx(Zt,{className:"h-3.5 w-3.5"})},{type:"fibonacci",label:"æ–æ³¢é‚£å¥‘",icon:e.jsx(Ke,{className:"h-3.5 w-3.5"})},{type:"golden",label:"é»ƒé‡‘åˆ†å‰²",icon:e.jsx(Ke,{className:"h-3.5 w-3.5"})},{type:"rectangle",label:"çŸ©å½¢",icon:e.jsx(Jt,{className:"h-3.5 w-3.5"})},{type:"text",label:"æ–‡å­—",icon:e.jsx(Qt,{className:"h-3.5 w-3.5"})}],Ce=["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6","#ec4899","#64748b"];function Ms({activeType:t,onTypeChange:n,drawingCount:r=0}){return e.jsxs("div",{className:"flex items-center gap-0.5 flex-wrap",children:[e.jsx(A,{variant:t==="off"?"default":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>n("off"),title:"æ­£å¸¸æ¨¡å¼ï¼ˆå¯æ‹–æ›³/åå­—è»¸ï¼‰",children:e.jsx(Bt,{className:"h-3.5 w-3.5"})}),r>0&&e.jsxs(A,{variant:t==="select"?"default":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>n("select"),title:"é¸æ“‡æ¨¡å¼ï¼ˆé»žé¸ç¹ªåœ–åˆªé™¤ï¼‰",children:[e.jsx(Kt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"ml-0.5 text-[10px] bg-muted px-1 rounded",children:r})]}),e.jsx("div",{className:"w-px h-5 bg-border mx-0.5"}),Ls.map(i=>e.jsxs(A,{variant:t===i.type?"default":"ghost",size:"sm",className:"h-7 px-1.5 text-xs",onClick:()=>n(i.type),title:i.label,children:[i.icon,e.jsx("span",{className:"ml-0.5 hidden sm:inline",children:i.label})]},i.type))]})}function Ts({width:t,height:n,drawings:r,activeType:i,selectedId:c,onAddDrawing:v,onSelectDrawing:m,onDeleteDrawing:p,chart:f,mainSeries:C}){const S=a.useRef(null),h=a.useRef(null),M=a.useRef(0),V=a.useRef(f),E=a.useRef(C);a.useEffect(()=>{V.current=f,E.current=C},[f,C]);const[L,x]=a.useState(!1),[z,ve]=a.useState(null),[ye,D]=a.useState(null),[q,te]=a.useState(null),[me,he]=a.useState(0),[P,Y]=a.useState({x:0,y:0,show:!1}),[re,xe]=a.useState(""),O=a.useRef(Ce[0]),[se,U]=a.useState(0),le=i==="off",J=i==="select",ie=!le&&!J,ne=a.useCallback(o=>{const s=V.current,d=E.current;if(!s||!d)return null;try{const u=s.timeScale().coordinateToLogical(o.x),b=d.coordinateToPrice(o.y);return u===null||b===null?null:{logicalIndex:u,price:b}}catch{return null}},[]),de=a.useCallback(o=>{const s=V.current,d=E.current;if(!s||!d)return null;try{const u=s.timeScale().logicalToCoordinate(o.logicalIndex),b=d.priceToCoordinate(o.price);return u===null||b===null?null:{x:u,y:b}}catch{return null}},[]);a.useEffect(()=>{if(!f)return;const o=()=>{U(s=>s+1)};return f.timeScale().subscribeVisibleLogicalRangeChange(o),()=>{f.timeScale().unsubscribeVisibleLogicalRangeChange(o)}},[f]);const we=a.useMemo(()=>{if(!c)return null;const o=r.find(u=>u.id===c);if(!o||o.points.length===0)return null;const s=de(o.points[0]);if(!s)return null;let d=s.x,l=s.y;if(o.type==="horizontal")d=t/2;else if(o.type==="vertical")l=n/2;else if(o.points.length>=2){const u=de(o.points[1]);u&&(d=(s.x+u.x)/2,l=(s.y+u.y)/2)}return d=Math.max(50,Math.min(t-50,d)),l=Math.max(25,Math.min(n-25,l)),{x:d,y:l}},[c,r,t,n,de,se]),j=a.useCallback((o,s)=>Math.sqrt((s.x-o.x)**2+(s.y-o.y)**2),[]),Ne=a.useCallback((o,s,d,l=10)=>{const u=j(s,d);if(u===0)return j(o,s)<l;const b=Math.max(0,Math.min(1,((o.x-s.x)*(d.x-s.x)+(o.y-s.y)*(d.y-s.y))/(u*u))),k={x:s.x+b*(d.x-s.x),y:s.y+b*(d.y-s.y)};return j(o,k)<l},[j]),_=a.useCallback((o,s,d,l="none")=>{if(o.beginPath(),l==="none")o.moveTo(s.x,s.y),o.lineTo(d.x,d.y);else{const u=d.x-s.x,b=d.y-s.y,k=Math.sqrt(u*u+b*b);if(k===0)return;const R=u/k,$=b/k,X=(F,W,ae,fe)=>{let ce=1/0;return ae>0&&(ce=Math.min(ce,(t-F)/ae)),ae<0&&(ce=Math.min(ce,-F/ae)),fe>0&&(ce=Math.min(ce,(n-W)/fe)),fe<0&&(ce=Math.min(ce,-W/fe)),{x:F+ae*ce,y:W+fe*ce}};if(l==="both"){const F=X(s.x,s.y,-R,-$),W=X(d.x,d.y,R,$);o.moveTo(F.x,F.y),o.lineTo(W.x,W.y)}else{const F=X(d.x,d.y,R,$);o.moveTo(s.x,s.y),o.lineTo(F.x,F.y)}}o.stroke()},[t,n]),B=a.useCallback((o,s,d,l)=>{const u=[0,.236,.382,.5,.618,.786,1],b=["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6","#ef4444"],k=Math.min(s.x,d.x),R=Math.max(s.x,d.x);u.forEach(($,X)=>{const F=s.y+(d.y-s.y)*$;o.strokeStyle=l?"#fff":b[X],o.lineWidth=1.5,o.setLineDash([5,3]),o.beginPath(),o.moveTo(k,F),o.lineTo(R,F),o.stroke(),o.setLineDash([]),o.font="10px sans-serif",o.fillStyle=l?"#fff":b[X],o.fillText(`${($*100).toFixed(1)}%`,R+5,F+3)})},[]),je=a.useCallback((o,s,d,l)=>{const u=[0,.382,.5,.618,1],b=["0%","38.2%","50%","61.8%","100%"],k=["#ef4444","#ffc107","#22c55e","#3b82f6","#ef4444"],R=Math.min(s.x,d.x),$=Math.max(s.x,d.x);u.forEach((W,ae)=>{const fe=s.y+(d.y-s.y)*W;o.strokeStyle=l?"#fff":k[ae],o.lineWidth=W===.618?2.5:1.5,o.setLineDash(W===.5?[5,3]:[]),o.beginPath(),o.moveTo(R,fe),o.lineTo($,fe),o.stroke(),o.setLineDash([]),o.font=W===.618?"bold 11px sans-serif":"10px sans-serif",o.fillStyle=l?"#fff":k[ae],o.fillText(b[ae]+(W===.618?" â˜…":""),$+5,fe+3)});const X=s.y+(d.y-s.y)*.382,F=s.y+(d.y-s.y)*.618;o.fillStyle=(l?"#ffffff":"#ffc107")+"15",o.fillRect(R,Math.min(X,F),$-R,Math.abs(F-X))},[]),Se=a.useCallback(()=>{const o=S.current;if(!o)return;const s=o.getContext("2d");if(s){s.clearRect(0,0,t,n);for(const d of r){const l=d.points.map(b=>de(b)).filter(b=>b!==null);if(l.length===0)continue;const u=d.id===c;switch(s.strokeStyle=u?"#ffffff":d.color,s.fillStyle=u?"#ffffff":d.color,s.lineWidth=u?2.5:2,s.setLineDash([]),d.type){case"trendline":l.length>=2&&(_(s,l[0],l[1],"both"),[0,1].forEach(b=>{s.beginPath(),s.arc(l[b].x,l[b].y,u?5:4,0,Math.PI*2),s.fill()}));break;case"segment":l.length>=2&&(_(s,l[0],l[1],"none"),[0,1].forEach(b=>{s.beginPath(),s.arc(l[b].x,l[b].y,u?5:4,0,Math.PI*2),s.fill()}));break;case"ray":l.length>=2&&(_(s,l[0],l[1],"end"),s.beginPath(),s.arc(l[0].x,l[0].y,u?5:4,0,Math.PI*2),s.fill());break;case"horizontal":l.length>=1&&(s.setLineDash([8,4]),s.beginPath(),s.moveTo(0,l[0].y),s.lineTo(t,l[0].y),s.stroke(),s.setLineDash([]));break;case"vertical":l.length>=1&&(s.setLineDash([8,4]),s.beginPath(),s.moveTo(l[0].x,0),s.lineTo(l[0].x,n),s.stroke(),s.setLineDash([]));break;case"parallel":if(l.length>=3){_(s,l[0],l[1],"both");const b=l[1].x-l[0].x,k=l[1].y-l[0].y,R=l[2];_(s,{x:R.x-b,y:R.y-k},{x:R.x+b,y:R.y+k},"both"),s.fillStyle=(u?"#ffffff":d.color)+"15",s.beginPath(),s.moveTo(l[0].x,l[0].y),s.lineTo(l[1].x,l[1].y),s.lineTo(R.x+b,R.y+k),s.lineTo(R.x-b,R.y-k),s.closePath(),s.fill()}break;case"fibonacci":l.length>=2&&B(s,l[0],l[1],u);break;case"golden":l.length>=2&&je(s,l[0],l[1],u);break;case"rectangle":if(l.length>=2){const b=Math.min(l[0].x,l[1].x),k=Math.min(l[0].y,l[1].y),R=Math.abs(l[1].x-l[0].x),$=Math.abs(l[1].y-l[0].y);s.fillStyle=(u?"#ffffff":d.color)+"20",s.fillRect(b,k,R,$),s.strokeRect(b,k,R,$)}break;case"text":if(l.length>=1&&d.text){s.font="bold 13px sans-serif";const b=s.measureText(d.text);s.fillStyle="#00000080",s.fillRect(l[0].x-2,l[0].y-14,b.width+4,18),s.fillStyle=u?"#ffffff":d.color,s.fillText(d.text,l[0].x,l[0].y)}break}}if(L&&z&&ie){s.strokeStyle=O.current,s.fillStyle=O.current,s.lineWidth=2,s.setLineDash([]);const d=ye||z;switch(i){case"trendline":_(s,z,d,"both");break;case"segment":_(s,z,d,"none");break;case"ray":_(s,z,d,"end");break;case"horizontal":s.setLineDash([8,4]),s.beginPath(),s.moveTo(0,d.y),s.lineTo(t,d.y),s.stroke();break;case"vertical":s.setLineDash([8,4]),s.beginPath(),s.moveTo(d.x,0),s.lineTo(d.x,n),s.stroke();break;case"parallel":if(me===0)_(s,z,d,"both");else if(q){_(s,z,q,"both");const R=q.x-z.x,$=q.y-z.y;_(s,{x:d.x-R,y:d.y-$},{x:d.x+R,y:d.y+$},"both")}break;case"fibonacci":B(s,z,d,!1);break;case"golden":je(s,z,d,!1);break;case"rectangle":const l=Math.min(z.x,d.x),u=Math.min(z.y,d.y),b=Math.abs(d.x-z.x),k=Math.abs(d.y-z.y);s.fillStyle=O.current+"20",s.fillRect(l,u,b,k),s.strokeRect(l,u,b,k);break}}}},[r,t,n,L,z,ye,q,i,c,me,ie,_,B,je,de,se]);a.useEffect(()=>(M.current&&cancelAnimationFrame(M.current),M.current=requestAnimationFrame(Se),()=>{M.current&&cancelAnimationFrame(M.current)}),[Se]);const y=a.useCallback(o=>{for(let s=r.length-1;s>=0;s--){const d=r[s],l=d.points.map(u=>de(u)).filter(u=>u!==null);if(l.length!==0)switch(d.type){case"trendline":case"segment":case"ray":if(l.length>=2&&Ne(o,l[0],l[1],12))return d;break;case"horizontal":if(l.length>=1&&Math.abs(o.y-l[0].y)<12)return d;break;case"vertical":if(l.length>=1&&Math.abs(o.x-l[0].x)<12)return d;break;case"parallel":if(l.length>=3){if(Ne(o,l[0],l[1],12))return d;const u=l[1].x-l[0].x,b=l[1].y-l[0].y,k=l[2];if(Ne(o,{x:k.x-u,y:k.y-b},{x:k.x+u,y:k.y+b},12))return d}break;case"rectangle":case"fibonacci":case"golden":if(l.length>=2){const u=Math.min(l[0].x,l[1].x)-5,b=Math.max(l[0].x,l[1].x)+5,k=Math.min(l[0].y,l[1].y)-5,R=Math.max(l[0].y,l[1].y)+5;if(o.x>=u&&o.x<=b&&o.y>=k&&o.y<=R)return d}break;case"text":if(l.length>=1&&d.text){const u=d.text.length*8+10;if(o.x>=l[0].x-5&&o.x<=l[0].x+u&&o.y>=l[0].y-18&&o.y<=l[0].y+5)return d}break}}return null},[r,Ne,de]),H=a.useCallback(o=>{var d;const s=(d=S.current)==null?void 0:d.getBoundingClientRect();return s?{x:o.clientX-s.left,y:o.clientY-s.top}:null},[]),Q=a.useCallback(o=>{if(!ie)return;const s=H(o);if(s){if(i==="text"){Y({x:s.x,y:s.y,show:!0});return}O.current=Ce[Math.floor(Math.random()*Ce.length)],x(!0),ve(s),D(s),he(0)}},[ie,i,H]),ue=a.useCallback(o=>{if(!L||!ie)return;const s=H(o);s&&D(s)},[L,ie,H]),ge=a.useCallback(()=>{if(!L||!z||!ie)return;const o=ye||z,s=ne(z),d=ne(o);if(!s||!d){console.warn("åº§æ¨™è½‰æ›å¤±æ•—ï¼Œåœ–è¡¨å¯èƒ½æœªæº–å‚™å¥½"),x(!1),ve(null),D(null),te(null),he(0);return}if(i==="parallel"&&me===0){te(o),he(1);return}let l;if(i==="horizontal"||i==="vertical")l=[d];else if(i==="parallel"&&q){const b=ne(q);if(!b){x(!1),ve(null),D(null),te(null),he(0);return}l=[s,b,d]}else l=[s,d];const u={id:Date.now().toString(),type:i,points:l,color:O.current};v(u),x(!1),ve(null),D(null),te(null),he(0)},[L,ie,z,ye,i,q,me,v,ne]),pe=a.useCallback(o=>{var u;if(!J)return;const s=(u=h.current)==null?void 0:u.getBoundingClientRect();if(!s)return;const d={x:o.clientX-s.left,y:o.clientY-s.top},l=y(d);l?(m(l.id),o.stopPropagation(),o.preventDefault()):m(null)},[J,y,m]),oe=a.useCallback(()=>{if(!re.trim()){Y({x:0,y:0,show:!1});return}const o=ne({x:P.x,y:P.y});if(!o){console.warn("æ–‡å­—åº§æ¨™è½‰æ›å¤±æ•—"),Y({x:0,y:0,show:!1}),xe("");return}v({id:Date.now().toString(),type:"text",points:[o],color:Ce[Math.floor(Math.random()*Ce.length)],text:re}),Y({x:0,y:0,show:!1}),xe("")},[re,P,v,ne]),be=a.useCallback(()=>{c&&(p(c),m(null))},[c,p,m]);return le?e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:e.jsx("canvas",{ref:S,width:t,height:n,className:"absolute inset-0"})}):e.jsxs("div",{ref:h,className:"absolute inset-0",style:{zIndex:10},children:[ie&&e.jsx("canvas",{ref:S,width:t,height:n,className:"absolute inset-0 cursor-crosshair",style:{pointerEvents:"auto"},onMouseDown:Q,onMouseMove:ue,onMouseUp:ge,onMouseLeave:()=>{L&&i!=="parallel"&&ge()}}),J&&e.jsxs(e.Fragment,{children:[e.jsx("canvas",{ref:S,width:t,height:n,className:"absolute inset-0",style:{pointerEvents:"none"}}),e.jsx("div",{className:"absolute inset-0 cursor-pointer",style:{pointerEvents:"auto"},onMouseDown:pe})]}),c&&we&&J&&e.jsxs(A,{variant:"destructive",size:"sm",className:"absolute h-7 px-2 text-xs shadow-lg animate-in fade-in zoom-in duration-150",style:{left:we.x-30,top:we.y-14,pointerEvents:"auto",zIndex:20},onClick:o=>{o.stopPropagation(),be()},children:[e.jsx(Ht,{className:"h-3.5 w-3.5 mr-1"}),"åˆªé™¤"]}),P.show&&e.jsxs("div",{className:"absolute flex items-center gap-1 bg-white dark:bg-gray-800 p-1 rounded shadow-lg border",style:{left:P.x,top:P.y,pointerEvents:"auto",zIndex:30},children:[e.jsx(hs,{value:re,onChange:o=>xe(o.target.value),onKeyDown:o=>{o.key==="Enter"&&oe(),o.key==="Escape"&&Y({x:0,y:0,show:!1})},placeholder:"è¼¸å…¥æ¨™è¨»...",className:"h-7 w-40 text-xs",autoFocus:!0}),e.jsx(A,{size:"sm",className:"h-7 px-2",onClick:oe,children:"ç¢ºå®š"}),e.jsx(A,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0",onClick:()=>Y({x:0,y:0,show:!1}),children:e.jsx(ut,{className:"h-3 w-3"})})]})]})}function zs(){const[t,n]=a.useState([]),[r,i]=a.useState("off"),[c,v]=a.useState(null),m=a.useCallback(h=>{n(M=>[...M,h])},[]),p=a.useCallback(h=>{n(M=>M.filter(V=>V.id!==h)),v(M=>M===h?null:M)},[]),f=a.useCallback((h,M)=>{n(V=>V.map(E=>E.id===h?{...E,...M}:E))},[]),C=a.useCallback(()=>{n([]),v(null)},[]),S=a.useMemo(()=>t.find(h=>h.id===c)||null,[t,c]);return{drawings:t,activeType:r,setActiveType:i,selectedId:c,setSelectedId:v,selectedDrawing:S,addDrawing:m,deleteDrawing:p,updateDrawing:f,clearDrawings:C}}const Xe={visibleStartDate:null,visibleEndDate:null,loadedStartDate:"2021-01-01",loadedEndDate:new Date().toISOString().split("T")[0],showMA5:!0,showMA10:!0,showMA20:!0,showMA60:!0,showMA120:!1,showBollinger:!1,showVolume:!0,macdParams:{fast:12,slow:26,signal:9},kdParams:{k:9,d:3,smooth:3},rsiParams:{period:14},bollingerParams:{period:20,std:2},zoomLevel:1,currentSymbol:null},Ps=Ct()(Ft(t=>({...Xe,setVisibleRange:(n,r)=>t({visibleStartDate:n,visibleEndDate:r}),setLoadedRange:(n,r)=>t({loadedStartDate:n,loadedEndDate:r}),toggleIndicator:n=>t(r=>({[n]:!r[n]})),setZoomLevel:n=>t({zoomLevel:n}),setCurrentSymbol:n=>t({currentSymbol:n}),setMacdParams:n=>t({macdParams:n}),setKdParams:n=>t({kdParams:n}),setRsiParams:n=>t({rsiParams:n}),setBollingerParams:n=>t({bollingerParams:n}),resetSettings:()=>t(Xe)}),{name:"chart-settings",partialize:t=>({showMA5:t.showMA5,showMA10:t.showMA10,showMA20:t.showMA20,showMA60:t.showMA60,showMA120:t.showMA120,showBollinger:t.showBollinger,showVolume:t.showVolume,macdParams:t.macdParams,kdParams:t.kdParams,rsiParams:t.rsiParams,bollingerParams:t.bollingerParams})})),Es=[{label:"1M",days:22,key:"1m"},{label:"3M",days:66,key:"3m"},{label:"6M",days:132,key:"6m"},{label:"1Y",days:252,key:"1y"},{label:"3Y",days:756,key:"3y"},{label:"5Y",days:1260,key:"5y"},{label:"å…¨éƒ¨",days:0,key:"all"}],_s={main:400,volume:120,indicator:200},Ds=a.forwardRef(({data:t,symbol:n,showBollinger:r=!1,isLoading:i=!1,chartHeights:c=_s,onLoadMore:v,onRangeChange:m,onCrosshairMove:p,onChartClick:f},C)=>{var k,R,$,X,F,W,ae,fe,ce,$e,Ae,Fe,We,Ue,Be;const[S,h]=a.useState(null),[M,V]=a.useState("macd"),[E,L]=a.useState("3m"),[x,z]=a.useState(null),{drawings:ve,activeType:ye,setActiveType:D,selectedId:q,setSelectedId:te,addDrawing:me,deleteDrawing:he}=zs(),[P,Y]=a.useState({width:0,height:0}),re=a.useRef(null);a.useEffect(()=>{if(!re.current)return;const g=new ResizeObserver(w=>{const N=w[0];N&&Y({width:N.contentRect.width,height:N.contentRect.height})});return g.observe(re.current),()=>g.disconnect()},[]);const xe=a.useCallback(g=>{z(g),p&&p(g)},[p]),{showMA5:O,showMA10:se,showMA20:U,showMA60:le,showMA120:J,showBollinger:ie,toggleIndicator:ne,setVisibleRange:de}=Ps(),we=r||ie,j=a.useRef(null),Ne=a.useRef(null),_=a.useRef(null),B=a.useRef(null),je=a.useRef(null),[Se,y]=a.useState({chart:null,series:null});a.useImperativeHandle(C,()=>({captureCharts:async g=>{const w=[j.current,_.current,B.current];let N=null;if(g&&j.current&&t.length>0){const T=t.findIndex(K=>K.date===g);if(T>=0){const K=j.current.timeScale().getVisibleLogicalRange();K&&(N={from:K.from,to:K.to});const St=N?N.to-N.from:60,kt=Math.max(0,T-St+5),Rt=T;w.forEach(Ee=>{Ee&&Ee.timeScale().setVisibleLogicalRange({from:kt,to:Rt})}),await new Promise(Ee=>setTimeout(Ee,150))}}const I=T=>T?T.takeScreenshot().toDataURL("image/png"):null,G={main:I(j.current)||"",volume:I(_.current)||"",indicator:I(B.current)||""};return N&&(await new Promise(T=>setTimeout(T,50)),w.forEach(T=>{T&&T.timeScale().setVisibleLogicalRange(N)})),G}}));const H=a.useMemo(()=>({ma5:O,ma10:se,ma20:U,ma60:le,ma120:J}),[O,se,U,le,J]),Q=a.useCallback((g,w)=>{const N=g.timeScale(),I=G=>{G&&w.forEach(T=>{T&&T.timeScale().setVisibleLogicalRange(G)})};return N.subscribeVisibleLogicalRangeChange(I),()=>{N.unsubscribeVisibleLogicalRangeChange(I)}},[]),ue=a.useCallback((g,w)=>{j.current=g,Ne.current=w,y({chart:g,series:w}),g.timeScale().subscribeVisibleLogicalRangeChange(N=>{if(!N||!t.length)return;const I=Math.max(0,Math.floor(N.from)),G=Math.min(t.length-1,Math.ceil(N.to));if(t[I]&&t[G]){const T=t[I].date,K=t[G].date;h({from:T,to:K}),de(T,K),m&&m(T,K)}}),_.current&&Q(g,[_.current]),B.current&&Q(g,[B.current])},[t,Q,de,m]),ge=a.useCallback(g=>{if(_.current=g,j.current){Q(g,[j.current]);const w=j.current.timeScale().getVisibleLogicalRange();w&&g.timeScale().setVisibleLogicalRange(w)}},[Q]),pe=a.useCallback(g=>{if(B.current=g,j.current){Q(g,[j.current]);const w=j.current.timeScale().getVisibleLogicalRange();w&&g.timeScale().setVisibleLogicalRange(w)}},[Q]),oe=a.useCallback((g,w)=>{if(!j.current||!t.length)return;L(w);const N=t.length-1,I=g===0?0:Math.max(0,N-g);[j.current,_.current,B.current].forEach(T=>{T&&T.timeScale().setVisibleLogicalRange({from:I,to:N+5})})},[t]),be=a.useCallback(()=>{oe(66,"3m")},[oe]),o=a.useCallback(()=>{if(!j.current)return;const g=j.current.timeScale().getVisibleLogicalRange();if(!g)return;const w=(g.from+g.to)/2,N=(g.to-g.from)*.7,I=w-N/2,G=w+N/2;[j.current,_.current,B.current].forEach(K=>{K&&K.timeScale().setVisibleLogicalRange({from:I,to:G})})},[]),s=a.useCallback(()=>{if(!j.current)return;const g=j.current.timeScale().getVisibleLogicalRange();if(!g)return;const w=(g.from+g.to)/2,N=(g.to-g.from)*1.4,I=Math.max(0,w-N/2),G=Math.min(t.length,w+N/2);[j.current,_.current,B.current].forEach(K=>{K&&K.timeScale().setVisibleLogicalRange({from:I,to:G})})},[t.length]),d=a.useCallback(()=>{if(!j.current)return;const g=j.current.timeScale().getVisibleLogicalRange();if(!g)return;const w=g.to-g.from,N=w*.3,I=Math.max(0,g.from-N),G=I+w;[j.current,_.current,B.current].forEach(K=>{K&&K.timeScale().setVisibleLogicalRange({from:I,to:G})})},[]),l=a.useCallback(()=>{if(!j.current)return;const g=j.current.timeScale().getVisibleLogicalRange();if(!g)return;const w=g.to-g.from,N=w*.3,I=Math.min(t.length+5,g.to+N),G=I-w;[j.current,_.current,B.current].forEach(K=>{K&&K.timeScale().setVisibleLogicalRange({from:G,to:I})})},[t.length]),u=a.useCallback(()=>{if(!j.current||!t.length)return;const g=j.current.timeScale().getVisibleLogicalRange();if(!g)return;const w=g.to-g.from,N=t.length+5,I=N-w;[j.current,_.current,B.current].forEach(T=>{T&&T.timeScale().setVisibleLogicalRange({from:I,to:N})})},[t.length]),b=a.useCallback(()=>{if(!j.current||!t.length)return;const g=j.current.timeScale().getVisibleLogicalRange();if(!g)return;const w=g.to-g.from,N=0,I=w;[j.current,_.current,B.current].forEach(T=>{T&&T.timeScale().setVisibleLogicalRange({from:N,to:I})})},[]);return a.useEffect(()=>{const g=w=>{var N;if(!(!((N=je.current)!=null&&N.contains(document.activeElement))&&document.activeElement!==document.body))switch(w.key){case"ArrowLeft":w.preventDefault(),d();break;case"ArrowRight":w.preventDefault(),l();break;case"+":case"=":w.preventDefault(),o();break;case"-":w.preventDefault(),s();break;case"Home":w.preventDefault(),u();break;case"End":w.preventDefault(),b();break;case"r":case"R":!w.ctrlKey&&!w.metaKey&&(w.preventDefault(),be());break}};return window.addEventListener("keydown",g),()=>window.removeEventListener("keydown",g)},[d,l,o,s,u,b,be]),a.useEffect(()=>{if(j.current&&B.current){const g=j.current.timeScale().getVisibleLogicalRange();g&&setTimeout(()=>{var w;(w=B.current)==null||w.timeScale().setVisibleLogicalRange(g)},50)}},[M]),a.useEffect(()=>{t.length>0&&setTimeout(()=>oe(66,"3m"),100)},[t.length,oe]),!t||t.length===0?e.jsx("div",{className:"flex items-center justify-center h-64 text-muted-foreground",children:i?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"h-5 w-5 animate-spin"}),"è¼‰å…¥ä¸­..."]}):"ç„¡è³‡æ–™"}):e.jsxs("div",{ref:je,className:"w-full space-y-2",tabIndex:0,children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 px-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:Es.map(g=>e.jsx(A,{variant:E===g.key?"default":"outline",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>oe(g.days,g.key),children:g.label},g.key))}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:d,title:"â† å¾€å·¦ç§»å‹•",children:e.jsx(es,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:l,title:"â†’ å¾€å³ç§»å‹•",children:e.jsx(ts,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,title:"+ æ”¾å¤§",children:e.jsx(ss,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:s,title:"- ç¸®å°",children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:u,title:"Home: è·³åˆ°æœ€æ–°",children:e.jsx(as,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:be,title:"R: é‡ç½®",children:e.jsx(rs,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsx(Ms,{activeType:ye,onTypeChange:D,drawingCount:ve.length})]}),S&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground bg-muted px-2 py-1 rounded",children:[e.jsx(ls,{className:"h-3 w-3"}),e.jsxs("span",{children:[S.from," ~ ",S.to]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs px-2",children:[e.jsxs("span",{children:[e.jsx("span",{className:"inline-block w-3 h-3 mr-1",style:{backgroundColor:"#ef5350"}})," ä¸Šæ¼²"]}),e.jsxs("span",{children:[e.jsx("span",{className:"inline-block w-3 h-3 mr-1",style:{backgroundColor:"#26a69a"}})," ä¸‹è·Œ"]}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:O?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:O?"#ffc107":void 0,color:O?"black":"#ffc107"},onClick:()=>ne("showMA5"),children:"MA5"}),O&&((x==null?void 0:x.ma5)??((k=t[t.length-1])==null?void 0:k.ma5))&&e.jsx("span",{className:"font-mono",style:{color:"#ffc107"},children:($=(x==null?void 0:x.ma5)??((R=t[t.length-1])==null?void 0:R.ma5))==null?void 0:$.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:se?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:se?"#9c27b0":void 0,color:se?"white":"#9c27b0"},onClick:()=>ne("showMA10"),children:"MA10"}),se&&((x==null?void 0:x.ma10)??((X=t[t.length-1])==null?void 0:X.ma10))&&e.jsx("span",{className:"font-mono",style:{color:"#9c27b0"},children:(W=(x==null?void 0:x.ma10)??((F=t[t.length-1])==null?void 0:F.ma10))==null?void 0:W.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:U?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:U?"#2196f3":void 0,color:U?"white":"#2196f3"},onClick:()=>ne("showMA20"),children:"MA20"}),U&&((x==null?void 0:x.ma20)??((ae=t[t.length-1])==null?void 0:ae.ma20))&&e.jsx("span",{className:"font-mono",style:{color:"#2196f3"},children:(ce=(x==null?void 0:x.ma20)??((fe=t[t.length-1])==null?void 0:fe.ma20))==null?void 0:ce.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:le?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:le?"#ff9800":void 0,color:le?"black":"#ff9800"},onClick:()=>ne("showMA60"),children:"MA60"}),le&&((x==null?void 0:x.ma60)??(($e=t[t.length-1])==null?void 0:$e.ma60))&&e.jsx("span",{className:"font-mono",style:{color:"#ff9800"},children:(Fe=(x==null?void 0:x.ma60)??((Ae=t[t.length-1])==null?void 0:Ae.ma60))==null?void 0:Fe.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:J?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:J?"#9e9e9e":void 0,color:J?"black":"#9e9e9e"},onClick:()=>ne("showMA120"),children:"MA120"}),J&&((x==null?void 0:x.ma120)??((We=t[t.length-1])==null?void 0:We.ma120))&&e.jsx("span",{className:"font-mono",style:{color:"#9e9e9e"},children:(Be=(x==null?void 0:x.ma120)??((Ue=t[t.length-1])==null?void 0:Ue.ma120))==null?void 0:Be.toFixed(2)})]}),we&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#e91e63"},children:"- -"})," å¸ƒæž—ä¸Šè»Œ"]}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#4caf50"},children:"- -"})," å¸ƒæž—ä¸‹è»Œ"]})]})]}),e.jsxs("div",{ref:re,className:"border rounded-lg overflow-hidden relative transition-all duration-300 ease-in-out",style:{height:c.main},children:[i&&e.jsx("div",{className:"absolute inset-0 bg-background/50 flex items-center justify-center z-10",children:e.jsx(Ve,{className:"h-6 w-6 animate-spin"})}),e.jsx(Ss,{data:t,height:c.main,showBollinger:we,visibleMAs:H,onChartReady:ue,onCrosshairMove:xe,onChartClick:f}),P.width>0&&e.jsx(Ts,{width:P.width,height:P.height,drawings:ve,activeType:ye,selectedId:q,onAddDrawing:me,onSelectDrawing:te,onDeleteDrawing:he,chart:Se.chart,mainSeries:Se.series})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden transition-all duration-300 ease-in-out",style:{height:c.volume+28},children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 text-xs text-muted-foreground border-b",children:[e.jsx("span",{children:"æˆäº¤é‡"}),e.jsxs("span",{className:"ml-2",children:[e.jsx("span",{className:"text-red-500",children:"â—"})," ä¸Šæ¼²",e.jsx("span",{className:"text-green-500 ml-2",children:"â—"})," ä¸‹è·Œ",e.jsx("span",{className:"ml-2",style:{color:"#ff9800"},children:"- -"})," 5æ—¥å‡é‡"]})]}),e.jsx(Cs,{data:t,height:c.volume,onChartReady:ge})]}),e.jsxs(js,{value:M,onValueChange:V,className:"w-full",children:[e.jsxs(Nt,{className:"grid w-full grid-cols-4",children:[e.jsxs(Le,{value:"macd",className:"flex items-center gap-1",children:[e.jsx(is,{className:"h-3 w-3"}),"MACD"]}),e.jsxs(Le,{value:"kd",className:"flex items-center gap-1",children:[e.jsx(mt,{className:"h-3 w-3"}),"KD"]}),e.jsxs(Le,{value:"rsi",className:"flex items-center gap-1",children:[e.jsx(Oe,{className:"h-3 w-3"}),"RSI"]}),e.jsx(Le,{value:"all",children:"å…¨éƒ¨"})]}),e.jsx(Me,{value:"macd",className:"border rounded-lg overflow-hidden mt-2",children:e.jsx(qe,{data:t,height:c.indicator,onChartReady:pe})}),e.jsx(Me,{value:"kd",className:"border rounded-lg overflow-hidden mt-2",children:e.jsx(Ge,{data:t,height:c.indicator,onChartReady:pe})}),e.jsx(Me,{value:"rsi",className:"border rounded-lg overflow-hidden mt-2",children:e.jsx(Ye,{data:t,height:c.indicator,onChartReady:pe})}),e.jsxs(Me,{value:"all",className:"space-y-2 mt-2",children:[e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx(qe,{data:t,height:150,onChartReady:pe})}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx(Ge,{data:t,height:150})}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx(Ye,{data:t,height:140})})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground text-center py-2",children:"ðŸ’¡ æ‹–æ›³ç§»å‹• | æ»¾è¼ªç¸®æ”¾ | â†â†’ æ–¹å‘éµç§»å‹• | +/- ç¸®æ”¾ | Home è·³åˆ°æœ€æ–° | R é‡ç½®"})]})}),ee=Lt.create({baseURL:"/api",timeout:12e4});ee.interceptors.response.use(t=>t,t=>{var r,i,c,v,m,p,f;const n=((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.detail)||((v=(c=t.response)==null?void 0:c.data)==null?void 0:v.error)||t.message||"è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";return t.code==="ECONNABORTED"?console.error("API è«‹æ±‚è¶…æ™‚:",(m=t.config)==null?void 0:m.url):((p=t.response)==null?void 0:p.status)===400?console.warn("API è«‹æ±‚åƒæ•¸éŒ¯èª¤:",n):((f=t.response)==null?void 0:f.status)>=500&&console.error("ä¼ºæœå™¨éŒ¯èª¤:",n),Promise.reject(new Error(n))});async function qs(t){const n=new URLSearchParams;Object.entries(t).forEach(([i,c])=>{c!=null&&(Array.isArray(c)?n.set(i,c.join(",")):n.set(i,String(c)))});const{data:r}=await ee.get(`/stocks/filter?${n}`);return r.data}async function Gs(){const{data:t}=await ee.get("/trading-date");return t.data}async function Ys(t,n){const r=new URLSearchParams;t&&r.set("date",t);const{data:i}=await ee.get(`/turnover/limit-up?${r}`);return i}async function Xs(t){const n=t?`?date=${t}`:"",{data:r}=await ee.get(`/turnover/top20${n}`);return r}async function Zs(t){const n=t?`?date=${t}`:"",{data:r}=await ee.get(`/turnover/top20-limit-up${n}`);return r}async function Js(t,n){const r=new URLSearchParams;t&&r.set("start_date",t),n&&r.set("end_date",n);const{data:i}=await ee.get(`/turnover/top200-limit-up?${r}`);return i}async function Qs(t,n,r,i){const c=new URLSearchParams;t&&c.set("start_date",t),n&&c.set("end_date",n),r!==void 0&&c.set("change_min",String(r)),i!==void 0&&c.set("change_max",String(i));const{data:v}=await ee.get(`/turnover/top200-change-range?${c}`);return v}async function en(t,n){const r=new URLSearchParams;t&&r.set("start_date",t),n&&r.set("end_date",n);const{data:i}=await ee.get(`/turnover/top200-5day-high?${r}`);return i}async function tn(t,n){const r=new URLSearchParams;t&&r.set("start_date",t),n&&r.set("end_date",n);const{data:i}=await ee.get(`/turnover/top200-5day-low?${r}`);return i}async function sn(t,n,r,i){const c=new URLSearchParams;t&&c.set("start_date",t),n&&c.set("end_date",n),r!==void 0&&c.set("min_change",String(r)),i!==void 0&&c.set("max_change",String(i));const{data:v}=await ee.get(`/turnover/ma-breakout?${c}`);return v}async function nn(t,n,r){const i=new URLSearchParams;t&&i.set("start_date",t),n&&i.set("end_date",n),r!==void 0&&i.set("volume_ratio",String(r));const{data:c}=await ee.get(`/turnover/volume-surge?${i}`);return c}async function an(t,n,r){const i=new URLSearchParams;t&&i.set("start_date",t),n&&i.set("end_date",n),r!==void 0&&i.set("min_days",String(r));const{data:c}=await ee.get(`/turnover/institutional-buy?${i}`);return c}async function rn(t,n,r,i,c,v,m,p,f,C,S){const h=new URLSearchParams;t&&h.set("start_date",t),n&&h.set("end_date",n),r!==void 0&&h.set("turnover_min",String(r)),i!==void 0&&h.set("turnover_max",String(i)),c!==void 0&&h.set("change_min",String(c)),v!==void 0&&h.set("change_max",String(v)),m!==void 0&&h.set("min_buy_days",String(m)),p!==void 0&&h.set("volume_ratio",String(p)),f!==void 0&&h.set("is_5day_high",String(f)),C!==void 0&&h.set("is_5day_low",String(C)),S!==void 0&&h.set("is_ma20_uptrend",String(S));const{data:M}=await ee.get(`/turnover/combo-filter?${h}`);return M}function ln(t,n,r){let i,c,v;if(t==="csv"){const C=Object.keys(n[0]||{}).join(","),S=n.map(h=>Object.values(h).map(M=>`"${M}"`).join(","));i=[C,...S].join(`
`),c="text/csv",v="csv"}else if(t==="json")i=JSON.stringify(n,null,2),c="application/json",v="json";else{const C=Object.keys(n[0]||{}).join(","),S=n.map(h=>Object.values(h).map(M=>`"${M}"`).join(","));i=[C,...S].join(`
`),c="text/csv",v="csv"}const m=new Blob(["\uFEFF"+i],{type:`${c};charset=utf-8`}),p=URL.createObjectURL(m),f=document.createElement("a");f.href=p,f.download=`${r}.${v}`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(p)}async function Is(t,n="day",r=5,i=!1){let c,v;typeof t=="string"?(v=t,c=new URLSearchParams,c.set("period",n),c.set("years",r.toString()),i&&c.set("force_refresh","true")):(v=t.symbol,c=new URLSearchParams,c.set("period",t.period||"day"),t.startDate&&c.set("start_date",t.startDate),t.endDate&&c.set("end_date",t.endDate),!t.startDate&&!t.endDate&&c.set("years",(t.years||5).toString()),t.forceRefresh&&c.set("force_refresh","true"));const{data:m}=await ee.get(`/stocks/${v}/kline?${c}`);return m.data}const Vs=[{value:"day",label:"æ—¥K"},{value:"week",label:"é€±K"},{value:"month",label:"æœˆK"}],Os={normal:{main:350,volume:100,indicator:180,dialogWidth:"max-w-5xl"},large:{main:500,volume:130,indicator:220,dialogWidth:"max-w-6xl"},xlarge:{main:650,volume:160,indicator:280,dialogWidth:"max-w-[95vw]"}},$s=5;function on({open:t,onClose:n,symbol:r,name:i}){var _,B,je,Se;const[c,v]=a.useState("day"),[m,p]=a.useState(!1),[f]=a.useState("xlarge"),[C,S]=a.useState(0),[h,M]=a.useState(null),[V,E]=a.useState(null),[L,x]=a.useState(!1),z=a.useRef(null),ve=a.useCallback(y=>{L||M(y)},[L]),ye=a.useCallback(()=>{L?(x(!1),E(null)):(x(!0),E(h))},[L,h]);a.useEffect(()=>{t&&r&&(S(0),x(!1),E(null))},[t,r]);const{data:D,isLoading:q,error:te,refetch:me,isFetching:he}=Mt({queryKey:["kline-5year",r,c,m,C],queryFn:async()=>{const y=await Is({symbol:r,period:c,years:$s,forceRefresh:m});return m&&p(!1),y},enabled:t&&!!r,staleTime:m?0:10*60*1e3,gcTime:30*60*1e3,retry:3,retryDelay:y=>Math.min(1e3*2**y,3e4),refetchOnWindowFocus:!1}),P=(D==null?void 0:D.kline_data)||[],Y=D==null?void 0:D.latest_price,re=(D==null?void 0:D.name)||i||r,xe=D==null?void 0:D.industry,O=D==null?void 0:D.data_range,se=(D==null?void 0:D.data_count)||0,U=a.useMemo(()=>{const y=L?V:h;if(y&&y.close!=null){const Q=P.findIndex(be=>be.date===y.date),ue=Q>0?P[Q-1].close:null,ge=ue!=null&&y.close!=null?y.close-ue:null,pe=ue!=null&&ue!==0&&ge!=null?ge/ue*100:null,oe=y.close!=null&&y.volume?y.close*y.volume/1e8:null;return{open:y.open,high:y.high,low:y.low,close:y.close,change:ge,changePct:pe,volume:y.volume,amount:oe,date:y.date}}const H=P.length>0?P[P.length-1]:null;return Y?{open:(H==null?void 0:H.open)??null,high:(H==null?void 0:H.high)??null,low:(H==null?void 0:H.low)??null,close:Y.close,change:Y.change,changePct:Y.change_pct,volume:Y.volume,amount:Y.amount,date:null}:null},[L,V,h,Y,P]),le=((U==null?void 0:U.change)||0)>=0,J=le?"text-red-500":"text-green-600",ie=le?Oe:us,ne=a.useCallback(async()=>{var y,H,Q,ue,ge,pe,oe,be,o;if(!(!z.current||!r))try{const s=L?V:h,d=(s==null?void 0:s.date)||(P.length>0?P[P.length-1].date:null),l=d?P.findIndex(ae=>ae.date===d):P.length-1,u=l>=0?P[l]:null,b=l>0?P[l-1]:null,k=u!=null&&u.close&&(b!=null&&b.close)?u.close-b.close:null,R=k!==null&&(b!=null&&b.close)?k/b.close*100:null,$=(k??0)>=0,X=await z.current.captureCharts(d||void 0),F=c==="day"?"æ—¥Kç·š":c==="week"?"é€±Kç·š":"æœˆKç·š",W=window.open("","_blank","width=1123,height=794");W&&(W.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${r} ${re} ${F}</title>
                        <style>
                            @page { size: A4 landscape; margin: 8mm; }
                            * { box-sizing: border-box; margin: 0; padding: 0; }
                            body {
                                font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                                padding: 12px;
                                background: #fff;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .container { width: 100%; max-width: 280mm; margin: 0 auto; }
                            .header {
                                display: flex; justify-content: space-between; align-items: flex-end;
                                margin-bottom: 10px; padding-bottom: 8px; border-bottom: 3px solid #000;
                            }
                            .title-group { display: flex; align-items: baseline; gap: 15px; }
                            .symbol { font-size: 28px; font-weight: 900; color: #000; }
                            .name { font-size: 20px; font-weight: bold; color: #333; }
                            .meta { color: #666; font-size: 11px; }
                            .info-section {
                                display: flex; gap: 10px; margin-bottom: 10px;
                            }
                            .price-grid {
                                display: flex; flex: 1; padding: 10px 15px;
                                background: #f1f5f9; border-radius: 8px; border: 1px solid #e2e8f0;
                            }
                            .price-item { text-align: center; flex: 1; border-right: 1px solid #cbd5e1; }
                            .price-item:last-child { border-right: none; }
                            .price-label { font-size: 11px; color: #64748b; margin-bottom: 3px; font-weight: 500; }
                            .price-value { font-size: 16px; font-weight: 800; }
                            .ma-grid {
                                display: flex; flex: 1; padding: 10px 15px;
                                background: #fefce8; border-radius: 8px; border: 1px solid #fef08a;
                            }
                            .ma-item { text-align: center; flex: 1; border-right: 1px solid #fde047; }
                            .ma-item:last-child { border-right: none; }
                            .ma-label { font-size: 11px; margin-bottom: 3px; font-weight: 600; }
                            .ma-value { font-size: 14px; font-weight: 700; }
                            .legend-row {
                                display: flex; align-items: center; gap: 15px; margin-bottom: 8px; padding: 6px 10px;
                                background: #f8fafc; border-radius: 6px; font-size: 11px;
                            }
                            .legend-item { display: flex; align-items: center; gap: 4px; }
                            .legend-box { width: 12px; height: 12px; border-radius: 2px; }
                            .up { color: #dc2626; }
                            .down { color: #16a34a; }
                            .chart-section { margin-bottom: 6px; }
                            .chart-image {
                                width: 100%; display: block; border: 1px solid #e5e7eb; border-radius: 4px;
                            }
                            .chart-label {
                                font-size: 10px; color: #64748b; margin-bottom: 2px; font-weight: 500;
                            }
                            .footer {
                                display: flex; justify-content: space-between; margin-top: 8px;
                                padding-top: 6px; border-top: 1px solid #eee; font-size: 10px; color: #94a3b8;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <div class="title-group">
                                    <span class="symbol">${r}</span>
                                    <span class="name">${re}</span>
                                    ${xe?`<span style="font-size:12px; background:#eee; padding:2px 6px; border-radius:4px;">${xe}</span>`:""}
                                    <span style="font-size:14px; background:#3b82f6; color:white; padding:3px 10px; border-radius:4px; font-weight:600;">${F}</span>
                                </div>
                                <div class="meta">è³‡æ–™æ—¥æœŸï¼š${(u==null?void 0:u.date)||"-"}</div>
                            </div>

                            <!-- åƒ¹æ ¼è³‡è¨Š + å‡ç·šè³‡è¨Š -->
                            <div class="info-section">
                                <div class="price-grid">
                                    <div class="price-item">
                                        <div class="price-label">é–‹ç›¤åƒ¹</div>
                                        <div class="price-value" style="color:#0f172a">${((y=u==null?void 0:u.open)==null?void 0:y.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="price-item">
                                        <div class="price-label">æ”¶ç›¤åƒ¹</div>
                                        <div class="price-value ${$?"up":"down"}">${((H=u==null?void 0:u.close)==null?void 0:H.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="price-item">
                                        <div class="price-label">æœ€é«˜åƒ¹</div>
                                        <div class="price-value up">${((Q=u==null?void 0:u.high)==null?void 0:Q.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="price-item">
                                        <div class="price-label">æœ€ä½Žåƒ¹</div>
                                        <div class="price-value down">${((ue=u==null?void 0:u.low)==null?void 0:ue.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="price-item">
                                        <div class="price-label">æ¼²è·Œå¹…</div>
                                        <div class="price-value ${$?"up":"down"}">${R!==null?($?"+":"")+R.toFixed(2)+"%":"-"}</div>
                                    </div>
                                </div>
                                <div class="ma-grid">
                                    <div class="ma-item">
                                        <div class="ma-label" style="color:#ffc107">MA5</div>
                                        <div class="ma-value" style="color:#b38600">${((ge=u==null?void 0:u.ma5)==null?void 0:ge.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="ma-item">
                                        <div class="ma-label" style="color:#9c27b0">MA10</div>
                                        <div class="ma-value" style="color:#7b1fa2">${((pe=u==null?void 0:u.ma10)==null?void 0:pe.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="ma-item">
                                        <div class="ma-label" style="color:#2196f3">MA20</div>
                                        <div class="ma-value" style="color:#1565c0">${((oe=u==null?void 0:u.ma20)==null?void 0:oe.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="ma-item">
                                        <div class="ma-label" style="color:#ff9800">MA60</div>
                                        <div class="ma-value" style="color:#e65100">${((be=u==null?void 0:u.ma60)==null?void 0:be.toFixed(2))??"-"}</div>
                                    </div>
                                    <div class="ma-item">
                                        <div class="ma-label" style="color:#9e9e9e">MA120</div>
                                        <div class="ma-value" style="color:#616161">${((o=u==null?void 0:u.ma120)==null?void 0:o.toFixed(2))??"-"}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- åœ–ä¾‹ -->
                            <div class="legend-row">
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#ef5350"></div>
                                    <span>ä¸Šæ¼²</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#26a69a"></div>
                                    <span>ä¸‹è·Œ</span>
                                </div>
                                <div style="width:1px; height:12px; background:#cbd5e1; margin:0 5px;"></div>
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#ffc107"></div>
                                    <span>MA5</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#9c27b0"></div>
                                    <span>MA10</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#2196f3"></div>
                                    <span>MA20</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#ff9800"></div>
                                    <span>MA60</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box" style="background:#9e9e9e"></div>
                                    <span>MA120</span>
                                </div>
                            </div>

                            <!-- Kç·šä¸»åœ–ï¼ˆæœ€å¤§ï¼‰ -->
                            <div class="chart-section">
                                <div class="chart-label">Kç·šåœ–</div>
                                <img src="${X.main}" class="chart-image" />
                            </div>

                            <!-- æˆäº¤é‡åœ– -->
                            <div class="chart-section">
                                <div class="chart-label">æˆäº¤é‡</div>
                                <img src="${X.volume}" class="chart-image" />
                            </div>

                            <!-- æŠ€è¡“æŒ‡æ¨™åœ– -->
                            <div class="chart-section">
                                <div class="chart-label">æŠ€è¡“æŒ‡æ¨™</div>
                                <img src="${X.indicator}" class="chart-image" />
                            </div>

                            <div class="footer">
                                <span>è³‡æ–™ä¾†æºï¼šTWSE / FinMind (è²“æ˜Ÿäººè³ºå¤§éŒ¢ç³»çµ±)</span>
                                <span>è³‡æ–™ç¯„åœï¼š${(O==null?void 0:O.first_date)||"-"} ~ ${(O==null?void 0:O.last_date)||"-"} (å…± ${se} ç­†)</span>
                            </div>
                        </div>
                    </body>
                    </html>
                `),W.document.close(),W.onload=()=>{setTimeout(()=>{W.focus(),W.print()},500)})}catch(s){console.error("åˆ—å°å¤±æ•—:",s),alert("åˆ—å°æº–å‚™å¤±æ•—ï¼Œè«‹é‡è©¦")}},[r,re,xe,O,se,P,L,V,h,c]),de=a.useCallback(()=>{p(!0),S(y=>y+1)},[]),we=a.useCallback(()=>{S(y=>y+1),me()},[me]);a.useEffect(()=>{m&&me()},[m,me]);const j=a.useMemo(()=>Os[f],[f]),Ne=a.useMemo(()=>{if(!te)return null;const y=te instanceof Error?te.message:"ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";return y.includes("timeout")?"è«‹æ±‚è¶…æ™‚ï¼Œå·²è‡ªå‹•é‡è©¦":y.includes("402")?"API é¡åº¦å·²ç”¨å®Œï¼Œè«‹ç¨å€™å†è©¦":y},[te]);return e.jsx(xs,{open:t,onOpenChange:y=>!y&&n(),children:e.jsxs(xt,{className:`${j.dialogWidth} max-h-[95vh] overflow-y-auto transition-all duration-300 ease-in-out`,children:[e.jsx(gt,{className:"no-print",children:e.jsxs(pt,{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pr-8",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-lg bg-blue-100 dark:bg-blue-900 px-2 py-0.5 rounded",children:r}),e.jsx("span",{className:"text-xl font-bold",children:re}),xe&&e.jsx("span",{className:"text-sm text-muted-foreground px-2 py-0.5 bg-muted rounded",children:xe})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs(bs,{value:c,onValueChange:y=>v(y),children:[e.jsx(bt,{className:"w-18 h-7 text-xs",children:e.jsx(vs,{})}),e.jsx(wt,{children:Vs.map(y=>e.jsx(jt,{value:y.value,children:y.label},y.value))})]}),e.jsxs(A,{variant:"outline",size:"sm",onClick:ne,className:"h-7 text-xs",disabled:q||P.length===0,children:[e.jsx(os,{className:"h-3.5 w-3.5 mr-1"}),"åˆ—å°"]}),e.jsxs(A,{variant:L?"default":"outline",size:"sm",onClick:ye,className:`h-7 text-xs ${L?"bg-amber-500 hover:bg-amber-600":""}`,disabled:q||P.length===0,children:[L?e.jsx(cs,{className:"h-3.5 w-3.5 mr-1"}):e.jsx(ds,{className:"h-3.5 w-3.5 mr-1"}),L?`å·²éŽ–å®š ${(V==null?void 0:V.date)||""}`:"éŽ–å®š"]}),e.jsx(A,{variant:"ghost",size:"icon",onClick:de,className:"h-7 w-7",disabled:q||he,children:e.jsx(He,{className:`h-4 w-4 ${q||he?"animate-spin":""}`})})]})]})}),U&&e.jsxs("div",{className:"grid grid-cols-6 gap-2 p-2 bg-gradient-to-r from-slate-50 to-blue-50 dark:from-slate-800 dark:to-blue-900 rounded-lg text-sm mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"é–‹ç›¤åƒ¹"}),e.jsx("div",{className:"text-base font-bold",children:((_=U.open)==null?void 0:_.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æ”¶ç›¤åƒ¹"}),e.jsx("div",{className:`text-base font-bold ${J}`,children:((B=U.close)==null?void 0:B.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æœ€é«˜åƒ¹"}),e.jsx("div",{className:"text-base font-bold text-red-500",children:((je=U.high)==null?void 0:je.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æœ€ä½Žåƒ¹"}),e.jsx("div",{className:"text-base font-bold text-green-600",children:((Se=U.low)==null?void 0:Se.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æ¼²è·Œå¹…"}),e.jsxs("div",{className:`text-base font-bold flex items-center justify-center ${J}`,children:[e.jsx(ie,{className:"h-3 w-3 mr-0.5"}),U.changePct!=null?`${le?"+":""}${U.changePct.toFixed(2)}%`:"-"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æˆäº¤é‡"}),e.jsx("div",{className:"text-base font-bold text-sky-500",children:U.volume!=null?U.volume.toLocaleString():"-"})]})]}),O&&e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground px-1 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fs,{className:"h-3 w-3"}),O.first_date," ~ ",O.last_date," (",se.toLocaleString(),"ç­†)"]}),se>=1e3&&e.jsx("span",{className:"text-green-600",children:"âœ“ 5å¹´å®Œæ•´"})]}),e.jsxs("div",{children:[q&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx(Ve,{className:"h-10 w-10 animate-spin text-primary"}),e.jsx("p",{className:"mt-3 text-muted-foreground",children:"è¼‰å…¥ 5 å¹´è³‡æ–™ä¸­..."}),e.jsx("p",{className:"text-xs text-muted-foreground/60",children:"é¦–æ¬¡ç´„éœ€ 30-60 ç§’"})]}),te&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx(ms,{className:"h-10 w-10 text-amber-500 mb-2"}),e.jsx("p",{className:"text-amber-600 font-medium",children:"è¼‰å…¥å¤±æ•—"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:Ne}),e.jsxs(A,{variant:"outline",onClick:we,className:"mt-3",children:[e.jsx(He,{className:"h-4 w-4 mr-1"}),"é‡è©¦"]})]}),!q&&!te&&P.length>0&&e.jsx(Ds,{ref:z,data:P,symbol:r||"",isLoading:he,chartHeights:j,onCrosshairMove:ve,onChartClick:y=>{x(!0),E(y)}}),!q&&!te&&P.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-muted-foreground",children:[e.jsx(mt,{className:"h-10 w-10 mb-2"}),e.jsx("p",{children:"ç„¡æ³•å–å¾—è³‡æ–™"}),e.jsx(A,{variant:"outline",onClick:we,className:"mt-3",children:"é‡è©¦"})]})]})]})})}export{on as S,Ys as a,Xs as b,Zs as c,ln as d,Js as e,qs as f,Gs as g,Qs as h,en as i,tn as j,sn as k,nn as l,an as m,rn as n};
