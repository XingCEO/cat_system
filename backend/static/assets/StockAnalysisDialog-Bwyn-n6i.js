import{j as e,c as Tt,i as zt,u as Pt}from"./vendor-data-CkOiUkF9.js";import{a}from"./vendor-react-CiXd1m8D.js";import{R as Et,P as Dt,C as Qe,a as It,T as et,O as tt,D as st,b as _t,V as Ot,c as nt,I as Vt,d as $t,e as at,f as At,g as rt,h as Wt,i as Ft,j as lt,k as it,L as ot,l as ct,m as Ut,n as dt,o as ut,p as ft}from"./vendor-radix-aGPdNwig.js";import{c as Z,B as A,p as Bt}from"./index-CN1IIGNT.js";import{X as mt,J as ht,K as Kt,N as Ht,O as qt,P as Gt,Q as Yt,e as Ve,V as Xt,W as Zt,Y as Jt,_ as Qt,$ as es,m as He,a0 as ts,a1 as ss,L as Oe,j as ns,k as as,a2 as rs,a3 as ls,a4 as is,g as os,v as cs,A as ds,n as gt,a5 as us,a6 as fs,a7 as ms,R as qe,a8 as hs,a9 as gs,T as xs}from"./vendor-utils-3hQanHZm.js";import{V as ze,f as Pe,I as Ee}from"./vendor-charts-2uieviVG.js";import{I as ps}from"./input-C5aoutXU.js";const bs=Et,vs=Dt,xt=a.forwardRef(({className:t,...s},r)=>e.jsx(tt,{ref:r,className:Z("fixed inset-0 z-50 bg-black/60 backdrop-blur-sm","data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s}));xt.displayName=tt.displayName;const pt=a.forwardRef(({className:t,children:s,...r},i)=>e.jsxs(vs,{children:[e.jsx(xt,{}),e.jsxs(Qe,{ref:i,className:Z("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4","border border-border/50 bg-background p-6 shadow-xl rounded-xl","dark:bg-card/95 dark:backdrop-blur-md dark:border-border/30","duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out","data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0","data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95","data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%]","data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%]",t),...r,children:[s,e.jsxs(It,{className:"absolute right-3 top-3 rounded-md p-1.5 text-muted-foreground/80 transition-all duration-200 hover:bg-muted hover:text-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none z-50",children:[e.jsx(mt,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"é—œé–‰"})]})]})]}));pt.displayName=Qe.displayName;const bt=({className:t,...s})=>e.jsx("div",{className:Z("flex flex-col space-y-1.5 text-center sm:text-left",t),...s});bt.displayName="DialogHeader";const vt=a.forwardRef(({className:t,...s},r)=>e.jsx(et,{ref:r,className:Z("text-lg font-semibold leading-none tracking-tight",t),...s}));vt.displayName=et.displayName;const ys=a.forwardRef(({className:t,...s},r)=>e.jsx(st,{ref:r,className:Z("text-sm text-muted-foreground",t),...s}));ys.displayName=st.displayName;const ws=_t,js=Ot,yt=a.forwardRef(({className:t,children:s,...r},i)=>e.jsxs(nt,{ref:i,className:Z("flex h-10 w-full items-center justify-between rounded-lg border border-input bg-background px-3 py-2 text-sm","ring-offset-background transition-all duration-200 cursor-pointer","placeholder:text-muted-foreground","hover:border-primary/50","focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:border-primary","disabled:cursor-not-allowed disabled:opacity-50","dark:bg-background/50 dark:hover:bg-background/80","[&>span]:line-clamp-1",t),...r,children:[s,e.jsx(Vt,{asChild:!0,children:e.jsx(ht,{className:"h-4 w-4 opacity-50"})})]}));yt.displayName=nt.displayName;const wt=a.forwardRef(({className:t,...s},r)=>e.jsx(lt,{ref:r,className:Z("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(Ht,{className:"h-4 w-4"})}));wt.displayName=lt.displayName;const jt=a.forwardRef(({className:t,...s},r)=>e.jsx(it,{ref:r,className:Z("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(ht,{className:"h-4 w-4"})}));jt.displayName=it.displayName;const Nt=a.forwardRef(({className:t,children:s,position:r="popper",...i},c)=>e.jsx($t,{children:e.jsxs(at,{ref:c,className:Z("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:r,...i,children:[e.jsx(wt,{}),e.jsx(At,{className:Z("p-1",r==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),e.jsx(jt,{})]})}));Nt.displayName=at.displayName;const Ns=a.forwardRef(({className:t,...s},r)=>e.jsx(ot,{ref:r,className:Z("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...s}));Ns.displayName=ot.displayName;const kt=a.forwardRef(({className:t,children:s,...r},i)=>e.jsxs(rt,{ref:i,className:Z("relative flex w-full cursor-pointer select-none items-center rounded-md py-1.5 pl-8 pr-2 text-sm outline-none","transition-colors duration-150","focus:bg-accent focus:text-accent-foreground","data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Wt,{children:e.jsx(Kt,{className:"h-4 w-4"})})}),e.jsx(Ft,{children:s})]}));kt.displayName=rt.displayName;const ks=a.forwardRef(({className:t,...s},r)=>e.jsx(ct,{ref:r,className:Z("-mx-1 my-1 h-px bg-muted",t),...s}));ks.displayName=ct.displayName;const Ss=Ut,St=a.forwardRef(({className:t,...s},r)=>e.jsx(dt,{ref:r,className:Z("inline-flex h-10 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground","dark:bg-muted/50",t),...s}));St.displayName=dt.displayName;const Me=a.forwardRef(({className:t,...s},r)=>e.jsx(ut,{ref:r,className:Z("inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1.5 text-sm font-medium","ring-offset-background transition-all duration-200 cursor-pointer","hover:text-foreground/80","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2","disabled:pointer-events-none disabled:opacity-50","data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm","dark:data-[state=active]:bg-background/80",t),...s}));Me.displayName=ut.displayName;const Te=a.forwardRef(({className:t,...s},r)=>e.jsx(ft,{ref:r,className:Z("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...s}));Te.displayName=ft.displayName;const De="#ef5350",Ie="#26a69a",Ce={ma5:"#ffc107",ma10:"#9c27b0",ma20:"#2196f3",ma60:"#ff9800",ma120:"#9e9e9e"},_e={upper:"#e91e63",middle:"#ffc107",lower:"#4caf50"};function Rs(t){return t.filter(s=>s.open!=null&&s.high!=null&&s.low!=null&&s.close!=null).map(s=>({time:s.date,open:s.open,high:s.high,low:s.low,close:s.close}))}function Se(t,s){return t.filter(r=>r[s]!=null&&typeof r[s]=="number").map(r=>({time:r.date,value:r[s]}))}function Cs({data:t,height:s=400,showBollinger:r=!1,visibleMAs:i={ma5:!0,ma10:!0,ma20:!0,ma60:!0,ma120:!1},onChartReady:c,onCrosshairMove:v,onChartClick:m}){const p=a.useRef(null),f=a.useRef(null),L=a.useRef(t),N=a.useRef({});return a.useEffect(()=>{if(!p.current)return;const h=ze(p.current,{width:p.current.clientWidth,height:s,layout:{background:{type:Ee.Solid,color:"#ffffff"},textColor:"#333333",attributionLogo:!1},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:Pe.Normal,vertLine:{width:1,color:"rgba(0, 0, 0, 0.3)",style:3},horzLine:{width:1,color:"rgba(0, 0, 0, 0.3)",style:3}},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",timeVisible:!0,secondsVisible:!1,rightOffset:0,barSpacing:8,minBarSpacing:2,fixLeftEdge:!1,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0,rightBarStaysOnScroll:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});f.current=h;const T=h.addCandlestickSeries({upColor:De,downColor:Ie,borderUpColor:De,borderDownColor:Ie,wickUpColor:De,wickDownColor:Ie});N.current.candlestick=T,N.current.ma5=h.addLineSeries({color:Ce.ma5,lineWidth:1,visible:i.ma5!==!1,lastValueVisible:!1,priceLineVisible:!1}),N.current.ma10=h.addLineSeries({color:Ce.ma10,lineWidth:1,visible:i.ma10!==!1,lastValueVisible:!1,priceLineVisible:!1}),N.current.ma20=h.addLineSeries({color:Ce.ma20,lineWidth:1,visible:i.ma20!==!1,lastValueVisible:!1,priceLineVisible:!1}),N.current.ma60=h.addLineSeries({color:Ce.ma60,lineWidth:1,visible:i.ma60!==!1,lastValueVisible:!1,priceLineVisible:!1}),N.current.ma120=h.addLineSeries({color:Ce.ma120,lineWidth:1,visible:i.ma120===!0,lastValueVisible:!1,priceLineVisible:!1}),N.current.bbUpper=h.addLineSeries({color:_e.upper,lineWidth:1,lineStyle:2,title:"BB Upper",visible:r}),N.current.bbMiddle=h.addLineSeries({color:_e.middle,lineWidth:1,title:"BB Middle",visible:r}),N.current.bbLower=h.addLineSeries({color:_e.lower,lineWidth:1,lineStyle:2,title:"BB Lower",visible:r});const O=new ResizeObserver(E=>{if(!h||E.length===0||E[0].target!==p.current)return;const M=E[0].contentRect;h.applyOptions({width:M.width,height:M.height})});return O.observe(p.current),v&&h.subscribeCrosshairMove(E=>{if(!E.time||!E.point){v(null);return}const M=E.time,g=L.current.find(z=>z.date===M);g&&v({date:g.date,open:g.open,high:g.high,low:g.low,close:g.close,volume:g.volume,ma5:g.ma5,ma10:g.ma10,ma20:g.ma20,ma60:g.ma60,ma120:g.ma120})}),h.subscribeClick(E=>{if(!E.time||!E.point)return;const M=E.time,g=L.current.find(z=>z.date===M);g&&m&&m({date:g.date,open:g.open,high:g.high,low:g.low,close:g.close,volume:g.volume,ma5:g.ma5,ma10:g.ma10,ma20:g.ma20,ma60:g.ma60,ma120:g.ma120})}),c&&c(h,T),()=>{O.disconnect(),h.remove(),f.current=null}},[]),a.useEffect(()=>{!f.current||!p.current||f.current.applyOptions({width:p.current.clientWidth,height:s})},[s]),a.useEffect(()=>{if(!f.current||!t||t.length===0)return;L.current=t;const h=N.current;h.candlestick&&h.candlestick.setData(Rs(t));const{ma5:T,ma10:O,ma20:E,ma60:M,ma120:g}=N.current;T&&T.setData(Se(t,"ma5")),O&&O.setData(Se(t,"ma10")),E&&E.setData(Se(t,"ma20")),M&&M.setData(Se(t,"ma60")),g&&g.setData(Se(t,"ma120")),h.bbUpper&&h.bbUpper.setData(Se(t,"bb_upper")),h.bbMiddle&&h.bbMiddle.setData(Se(t,"bb_middle")),h.bbLower&&h.bbLower.setData(Se(t,"bb_lower"))},[t,f.current]),a.useEffect(()=>{const h=N.current;h.ma5&&h.ma5.applyOptions({visible:i.ma5!==!1}),h.ma10&&h.ma10.applyOptions({visible:i.ma10!==!1}),h.ma20&&h.ma20.applyOptions({visible:i.ma20!==!1}),h.ma60&&h.ma60.applyOptions({visible:i.ma60!==!1}),h.ma120&&h.ma120.applyOptions({visible:i.ma120===!0})},[i]),a.useEffect(()=>{const h=N.current;h.bbUpper&&h.bbUpper.applyOptions({visible:r}),h.bbMiddle&&h.bbMiddle.applyOptions({visible:r}),h.bbLower&&h.bbLower.applyOptions({visible:r})},[r]),e.jsx("div",{ref:p,className:"w-full",style:{height:`${s}px`}})}const Ls="rgba(239, 83, 80, 0.6)",Ms="rgba(38, 166, 154, 0.6)";function Ts({data:t,height:s=120,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef({});return a.useEffect(()=>{if(!i.current)return;const m=ze(i.current,{width:i.current.clientWidth,height:s,layout:{background:{type:Ee.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:Pe.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.1,bottom:0}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current.volume=m.addHistogramSeries({priceFormat:{type:"volume"},priceScaleId:"right"}),v.current.volumeMa5=m.addLineSeries({color:"#ff9800",lineWidth:1,lineStyle:2,priceScaleId:"right"});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const L=f[0].contentRect;m.applyOptions({width:L.width,height:L.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,s)},[s]),a.useEffect(()=>{if(!t||t.length===0)return;const m=v.current;if(m.volume){const p=t.map(f=>({time:f.date,value:f.volume||0,color:(f.close||0)>=(f.open||0)?Ls:Ms}));m.volume.setData(p)}if(m.volumeMa5){const p=t.filter(f=>f.volume_ma5!=null).map(f=>({time:f.date,value:f.volume_ma5}));m.volumeMa5.setData(p)}},[t]),e.jsx("div",{ref:i,className:"w-full",style:{height:`${s}px`}})}function Ge({data:t,height:s=200,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef({});return a.useEffect(()=>{if(!i.current)return;const m=ze(i.current,{width:i.current.clientWidth,height:s,layout:{background:{type:Ee.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:Pe.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current.histogram=m.addHistogramSeries({priceFormat:{type:"price",precision:4,minMove:1e-4},priceScaleId:"right"}),v.current.macd=m.addLineSeries({color:"#2196f3",lineWidth:2,priceScaleId:"right"}),v.current.signal=m.addLineSeries({color:"#ff9800",lineWidth:2,priceScaleId:"right"});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const L=f[0].contentRect;m.applyOptions({width:L.width,height:L.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,s)},[s]),a.useEffect(()=>{if(!t||t.length===0)return;const m=v.current;if(m.histogram){const p=t.filter(f=>f.macd_hist!=null).map(f=>({time:f.date,value:f.macd_hist,color:(f.macd_hist||0)>=0?"#ef5350":"#26a69a"}));m.histogram.setData(p)}if(m.macd){const p=t.filter(f=>f.macd!=null).map(f=>({time:f.date,value:f.macd}));m.macd.setData(p)}if(m.signal){const p=t.filter(f=>f.macd_signal!=null).map(f=>({time:f.date,value:f.macd_signal}));m.signal.setData(p)}},[t]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1 text-xs border-b",children:[e.jsx("span",{className:"font-medium",children:"MACD (12, 26, 9)"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#2196f3"},children:"â—"})," MACD"]}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#ff9800"},children:"â—"})," Signal"]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-red-500",children:"â– "}),"/",e.jsx("span",{className:"text-green-500",children:"â– "})," Histogram"]})]}),e.jsx("div",{ref:i,className:"w-full",style:{height:`${s}px`}})]})}function Ye({data:t,height:s=200,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef({});return a.useEffect(()=>{if(!i.current)return;const m=ze(i.current,{width:i.current.clientWidth,height:s,layout:{background:{type:Ee.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:Pe.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current.kLine=m.addLineSeries({color:"#2196f3",lineWidth:2,priceScaleId:"right"}),v.current.dLine=m.addLineSeries({color:"#ff9800",lineWidth:2,priceScaleId:"right"}),m.priceScale("right").applyOptions({autoScale:!1,scaleMargins:{top:0,bottom:0}});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const L=f[0].contentRect;m.applyOptions({width:L.width,height:L.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,s)},[s]),a.useEffect(()=>{if(!t||t.length===0)return;const m=v.current;if(m.kLine){const p=t.filter(f=>f.k!=null).map(f=>({time:f.date,value:f.k}));m.kLine.setData(p)}if(m.dLine){const p=t.filter(f=>f.d!=null).map(f=>({time:f.date,value:f.d}));m.dLine.setData(p)}},[t]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1 text-xs border-b",children:[e.jsx("span",{className:"font-medium",children:"KD éš¨æ©ŸæŒ‡æ¨™ (9, 3, 3)"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#2196f3"},children:"â—"})," Kå€¼"]}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#ff9800"},children:"â—"})," Då€¼"]}),e.jsx("span",{className:"text-muted-foreground",children:"è¶…è²· 80+ / è¶…è³£ 20-"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{top:"5%",height:"20%",backgroundColor:"rgba(239, 83, 80, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{bottom:"5%",height:"20%",backgroundColor:"rgba(38, 166, 154, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute right-2 text-[10px] text-red-400 pointer-events-none",style:{top:"15%"},children:"80"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-muted-foreground pointer-events-none",style:{top:"45%"},children:"50"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-green-400 pointer-events-none",style:{bottom:"15%"},children:"20"}),e.jsx("div",{ref:i,className:"w-full relative",style:{height:`${s}px`,zIndex:2}})]})]})}function Xe({data:t,height:s=180,onChartReady:r}){const i=a.useRef(null),c=a.useRef(null),v=a.useRef(null);return a.useEffect(()=>{if(!i.current)return;const m=ze(i.current,{width:i.current.clientWidth,height:s,layout:{background:{type:Ee.Solid,color:"#ffffff"},textColor:"#333333"},grid:{vertLines:{color:"rgba(197, 203, 206, 0.3)"},horzLines:{color:"rgba(197, 203, 206, 0.3)"}},crosshair:{mode:Pe.Normal},rightPriceScale:{borderColor:"rgba(197, 203, 206, 0.8)",scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:"rgba(197, 203, 206, 0.8)",visible:!1,rightOffset:0,fixRightEdge:!0,lockVisibleTimeRangeOnResize:!0},handleScroll:{mouseWheel:!0,pressedMouseMove:!0,horzTouchDrag:!0,vertTouchDrag:!1},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}});c.current=m,v.current=m.addLineSeries({color:"#9c27b0",lineWidth:2,priceScaleId:"right"}),m.priceScale("right").applyOptions({autoScale:!1,scaleMargins:{top:0,bottom:0}});const p=new ResizeObserver(f=>{if(!m||f.length===0||f[0].target!==i.current)return;const L=f[0].contentRect;m.applyOptions({width:L.width,height:L.height})});return p.observe(i.current),r&&r(m),()=>{p.disconnect(),m.remove(),c.current=null}},[]),a.useEffect(()=>{!c.current||!i.current||c.current.resize(i.current.clientWidth,s)},[s]),a.useEffect(()=>{if(!t||t.length===0||!v.current)return;const m=t.filter(p=>p.rsi!=null).map(p=>({time:p.date,value:p.rsi}));v.current.setData(m)},[t]),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1 text-xs border-b",children:[e.jsx("span",{className:"font-medium",children:"RSI ç›¸å°å¼·å¼±æŒ‡æ¨™ (14)"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#9c27b0"},children:"â—"})," RSI"]}),e.jsx("span",{className:"text-muted-foreground",children:"è¶…è²· 70+ / è¶…è³£ 30-"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{top:"5%",height:"30%",backgroundColor:"rgba(239, 83, 80, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute left-0 right-0 pointer-events-none",style:{bottom:"5%",height:"30%",backgroundColor:"rgba(38, 166, 154, 0.08)",zIndex:1}}),e.jsx("div",{className:"absolute right-2 text-[10px] text-red-400 pointer-events-none",style:{top:"20%"},children:"70"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-muted-foreground pointer-events-none",style:{top:"45%"},children:"50"}),e.jsx("div",{className:"absolute right-2 text-[10px] text-green-400 pointer-events-none",style:{bottom:"20%"},children:"30"}),e.jsx("div",{ref:i,className:"w-full relative",style:{height:`${s}px`,zIndex:2}})]})]})}const zs=[{type:"trendline",label:"è¶¨å‹¢ç·š",icon:e.jsx(Ve,{className:"h-3.5 w-3.5"})},{type:"segment",label:"ç·šæ®µ",icon:e.jsx(Xt,{className:"h-3.5 w-3.5"})},{type:"ray",label:"å°„ç·š",icon:e.jsx(Zt,{className:"h-3.5 w-3.5"})},{type:"horizontal",label:"æ°´å¹³",icon:e.jsx(Jt,{className:"h-3.5 w-3.5"})},{type:"vertical",label:"å‚ç›´",icon:e.jsx(Qt,{className:"h-3.5 w-3.5"})},{type:"parallel",label:"é€šé“",icon:e.jsx(es,{className:"h-3.5 w-3.5"})},{type:"fibonacci",label:"æ–æ³¢é‚£å¥‘",icon:e.jsx(He,{className:"h-3.5 w-3.5"})},{type:"golden",label:"é»ƒé‡‘åˆ†å‰²",icon:e.jsx(He,{className:"h-3.5 w-3.5"})},{type:"rectangle",label:"çŸ©å½¢",icon:e.jsx(ts,{className:"h-3.5 w-3.5"})},{type:"text",label:"æ–‡å­—",icon:e.jsx(ss,{className:"h-3.5 w-3.5"})}],Le=["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6","#ec4899","#64748b"];function Ps({activeType:t,onTypeChange:s,drawingCount:r=0}){return e.jsxs("div",{className:"flex items-center gap-0.5 flex-wrap",children:[e.jsx(A,{variant:t==="off"?"default":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>s("off"),title:"æ­£å¸¸æ¨¡å¼ï¼ˆå¯æ‹–æ›³/åå­—è»¸ï¼‰",children:e.jsx(qt,{className:"h-3.5 w-3.5"})}),r>0&&e.jsxs(A,{variant:t==="select"?"default":"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>s("select"),title:"é¸æ“‡æ¨¡å¼ï¼ˆé»é¸ç¹ªåœ–åˆªé™¤ï¼‰",children:[e.jsx(Gt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"ml-0.5 text-[10px] bg-muted px-1 rounded",children:r})]}),e.jsx("div",{className:"w-px h-5 bg-border mx-0.5"}),zs.map(i=>e.jsxs(A,{variant:t===i.type?"default":"ghost",size:"sm",className:"h-7 px-1.5 text-xs",onClick:()=>s(i.type),title:i.label,children:[i.icon,e.jsx("span",{className:"ml-0.5 hidden sm:inline",children:i.label})]},i.type))]})}function Es({width:t,height:s,drawings:r,activeType:i,selectedId:c,onAddDrawing:v,onSelectDrawing:m,onDeleteDrawing:p,chart:f,mainSeries:L}){const N=a.useRef(null),h=a.useRef(null),T=a.useRef(0),O=a.useRef(f),E=a.useRef(L);a.useEffect(()=>{O.current=f,E.current=L},[f,L]);const[M,g]=a.useState(!1),[z,ve]=a.useState(null),[ye,D]=a.useState(null),[q,te]=a.useState(null),[me,he]=a.useState(0),[P,Y]=a.useState({x:0,y:0,show:!1}),[re,ge]=a.useState(""),V=a.useRef(Le[0]),[se,U]=a.useState(0),le=i==="off",J=i==="select",ie=!le&&!J,ne=a.useCallback(o=>{const n=O.current,d=E.current;if(!n||!d)return null;try{const u=n.timeScale().coordinateToLogical(o.x),b=d.coordinateToPrice(o.y);return u===null||b===null?null:{logicalIndex:u,price:b}}catch{return null}},[]),de=a.useCallback(o=>{const n=O.current,d=E.current;if(!n||!d)return null;try{const u=n.timeScale().logicalToCoordinate(o.logicalIndex),b=d.priceToCoordinate(o.price);return u===null||b===null?null:{x:u,y:b}}catch{return null}},[]);a.useEffect(()=>{if(!f)return;const o=()=>{U(n=>n+1)};return f.timeScale().subscribeVisibleLogicalRangeChange(o),()=>{f.timeScale().unsubscribeVisibleLogicalRangeChange(o)}},[f]);const we=a.useMemo(()=>{if(!c)return null;const o=r.find(u=>u.id===c);if(!o||o.points.length===0)return null;const n=de(o.points[0]);if(!n)return null;let d=n.x,l=n.y;if(o.type==="horizontal")d=t/2;else if(o.type==="vertical")l=s/2;else if(o.points.length>=2){const u=de(o.points[1]);u&&(d=(n.x+u.x)/2,l=(n.y+u.y)/2)}return d=Math.max(50,Math.min(t-50,d)),l=Math.max(25,Math.min(s-25,l)),{x:d,y:l}},[c,r,t,s,de,se]),j=a.useCallback((o,n)=>Math.sqrt((n.x-o.x)**2+(n.y-o.y)**2),[]),Ne=a.useCallback((o,n,d,l=10)=>{const u=j(n,d);if(u===0)return j(o,n)<l;const b=Math.max(0,Math.min(1,((o.x-n.x)*(d.x-n.x)+(o.y-n.y)*(d.y-n.y))/(u*u))),k={x:n.x+b*(d.x-n.x),y:n.y+b*(d.y-n.y)};return j(o,k)<l},[j]),I=a.useCallback((o,n,d,l="none")=>{if(o.beginPath(),l==="none")o.moveTo(n.x,n.y),o.lineTo(d.x,d.y);else{const u=d.x-n.x,b=d.y-n.y,k=Math.sqrt(u*u+b*b);if(k===0)return;const C=u/k,$=b/k,X=(W,F,ae,fe)=>{let ce=1/0;return ae>0&&(ce=Math.min(ce,(t-W)/ae)),ae<0&&(ce=Math.min(ce,-W/ae)),fe>0&&(ce=Math.min(ce,(s-F)/fe)),fe<0&&(ce=Math.min(ce,-F/fe)),{x:W+ae*ce,y:F+fe*ce}};if(l==="both"){const W=X(n.x,n.y,-C,-$),F=X(d.x,d.y,C,$);o.moveTo(W.x,W.y),o.lineTo(F.x,F.y)}else{const W=X(d.x,d.y,C,$);o.moveTo(n.x,n.y),o.lineTo(W.x,W.y)}}o.stroke()},[t,s]),B=a.useCallback((o,n,d,l)=>{const u=[0,.236,.382,.5,.618,.786,1],b=["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6","#ef4444"],k=Math.min(n.x,d.x),C=Math.max(n.x,d.x);u.forEach(($,X)=>{const W=n.y+(d.y-n.y)*$;o.strokeStyle=l?"#fff":b[X],o.lineWidth=1.5,o.setLineDash([5,3]),o.beginPath(),o.moveTo(k,W),o.lineTo(C,W),o.stroke(),o.setLineDash([]),o.font="10px sans-serif",o.fillStyle=l?"#fff":b[X],o.fillText(`${($*100).toFixed(1)}%`,C+5,W+3)})},[]),je=a.useCallback((o,n,d,l)=>{const u=[0,.382,.5,.618,1],b=["0%","38.2%","50%","61.8%","100%"],k=["#ef4444","#ffc107","#22c55e","#3b82f6","#ef4444"],C=Math.min(n.x,d.x),$=Math.max(n.x,d.x);u.forEach((F,ae)=>{const fe=n.y+(d.y-n.y)*F;o.strokeStyle=l?"#fff":k[ae],o.lineWidth=F===.618?2.5:1.5,o.setLineDash(F===.5?[5,3]:[]),o.beginPath(),o.moveTo(C,fe),o.lineTo($,fe),o.stroke(),o.setLineDash([]),o.font=F===.618?"bold 11px sans-serif":"10px sans-serif",o.fillStyle=l?"#fff":k[ae],o.fillText(b[ae]+(F===.618?" â˜…":""),$+5,fe+3)});const X=n.y+(d.y-n.y)*.382,W=n.y+(d.y-n.y)*.618;o.fillStyle=(l?"#ffffff":"#ffc107")+"15",o.fillRect(C,Math.min(X,W),$-C,Math.abs(W-X))},[]),ke=a.useCallback(()=>{const o=N.current;if(!o)return;const n=o.getContext("2d");if(n){n.clearRect(0,0,t,s);for(const d of r){const l=d.points.map(b=>de(b)).filter(b=>b!==null);if(l.length===0)continue;const u=d.id===c;switch(n.strokeStyle=u?"#ffffff":d.color,n.fillStyle=u?"#ffffff":d.color,n.lineWidth=u?2.5:2,n.setLineDash([]),d.type){case"trendline":l.length>=2&&(I(n,l[0],l[1],"both"),[0,1].forEach(b=>{n.beginPath(),n.arc(l[b].x,l[b].y,u?5:4,0,Math.PI*2),n.fill()}));break;case"segment":l.length>=2&&(I(n,l[0],l[1],"none"),[0,1].forEach(b=>{n.beginPath(),n.arc(l[b].x,l[b].y,u?5:4,0,Math.PI*2),n.fill()}));break;case"ray":l.length>=2&&(I(n,l[0],l[1],"end"),n.beginPath(),n.arc(l[0].x,l[0].y,u?5:4,0,Math.PI*2),n.fill());break;case"horizontal":l.length>=1&&(n.setLineDash([8,4]),n.beginPath(),n.moveTo(0,l[0].y),n.lineTo(t,l[0].y),n.stroke(),n.setLineDash([]));break;case"vertical":l.length>=1&&(n.setLineDash([8,4]),n.beginPath(),n.moveTo(l[0].x,0),n.lineTo(l[0].x,s),n.stroke(),n.setLineDash([]));break;case"parallel":if(l.length>=3){I(n,l[0],l[1],"both");const b=l[1].x-l[0].x,k=l[1].y-l[0].y,C=l[2];I(n,{x:C.x-b,y:C.y-k},{x:C.x+b,y:C.y+k},"both"),n.fillStyle=(u?"#ffffff":d.color)+"15",n.beginPath(),n.moveTo(l[0].x,l[0].y),n.lineTo(l[1].x,l[1].y),n.lineTo(C.x+b,C.y+k),n.lineTo(C.x-b,C.y-k),n.closePath(),n.fill()}break;case"fibonacci":l.length>=2&&B(n,l[0],l[1],u);break;case"golden":l.length>=2&&je(n,l[0],l[1],u);break;case"rectangle":if(l.length>=2){const b=Math.min(l[0].x,l[1].x),k=Math.min(l[0].y,l[1].y),C=Math.abs(l[1].x-l[0].x),$=Math.abs(l[1].y-l[0].y);n.fillStyle=(u?"#ffffff":d.color)+"20",n.fillRect(b,k,C,$),n.strokeRect(b,k,C,$)}break;case"text":if(l.length>=1&&d.text){n.font="bold 13px sans-serif";const b=n.measureText(d.text);n.fillStyle="#00000080",n.fillRect(l[0].x-2,l[0].y-14,b.width+4,18),n.fillStyle=u?"#ffffff":d.color,n.fillText(d.text,l[0].x,l[0].y)}break}}if(M&&z&&ie){n.strokeStyle=V.current,n.fillStyle=V.current,n.lineWidth=2,n.setLineDash([]);const d=ye||z;switch(i){case"trendline":I(n,z,d,"both");break;case"segment":I(n,z,d,"none");break;case"ray":I(n,z,d,"end");break;case"horizontal":n.setLineDash([8,4]),n.beginPath(),n.moveTo(0,d.y),n.lineTo(t,d.y),n.stroke();break;case"vertical":n.setLineDash([8,4]),n.beginPath(),n.moveTo(d.x,0),n.lineTo(d.x,s),n.stroke();break;case"parallel":if(me===0)I(n,z,d,"both");else if(q){I(n,z,q,"both");const C=q.x-z.x,$=q.y-z.y;I(n,{x:d.x-C,y:d.y-$},{x:d.x+C,y:d.y+$},"both")}break;case"fibonacci":B(n,z,d,!1);break;case"golden":je(n,z,d,!1);break;case"rectangle":const l=Math.min(z.x,d.x),u=Math.min(z.y,d.y),b=Math.abs(d.x-z.x),k=Math.abs(d.y-z.y);n.fillStyle=V.current+"20",n.fillRect(l,u,b,k),n.strokeRect(l,u,b,k);break}}}},[r,t,s,M,z,ye,q,i,c,me,ie,I,B,je,de,se]);a.useEffect(()=>(T.current&&cancelAnimationFrame(T.current),T.current=requestAnimationFrame(ke),()=>{T.current&&cancelAnimationFrame(T.current)}),[ke]);const y=a.useCallback(o=>{for(let n=r.length-1;n>=0;n--){const d=r[n],l=d.points.map(u=>de(u)).filter(u=>u!==null);if(l.length!==0)switch(d.type){case"trendline":case"segment":case"ray":if(l.length>=2&&Ne(o,l[0],l[1],12))return d;break;case"horizontal":if(l.length>=1&&Math.abs(o.y-l[0].y)<12)return d;break;case"vertical":if(l.length>=1&&Math.abs(o.x-l[0].x)<12)return d;break;case"parallel":if(l.length>=3){if(Ne(o,l[0],l[1],12))return d;const u=l[1].x-l[0].x,b=l[1].y-l[0].y,k=l[2];if(Ne(o,{x:k.x-u,y:k.y-b},{x:k.x+u,y:k.y+b},12))return d}break;case"rectangle":case"fibonacci":case"golden":if(l.length>=2){const u=Math.min(l[0].x,l[1].x)-5,b=Math.max(l[0].x,l[1].x)+5,k=Math.min(l[0].y,l[1].y)-5,C=Math.max(l[0].y,l[1].y)+5;if(o.x>=u&&o.x<=b&&o.y>=k&&o.y<=C)return d}break;case"text":if(l.length>=1&&d.text){const u=d.text.length*8+10;if(o.x>=l[0].x-5&&o.x<=l[0].x+u&&o.y>=l[0].y-18&&o.y<=l[0].y+5)return d}break}}return null},[r,Ne,de]),K=a.useCallback(o=>{var d;const n=(d=N.current)==null?void 0:d.getBoundingClientRect();return n?{x:o.clientX-n.left,y:o.clientY-n.top}:null},[]),Q=a.useCallback(o=>{if(!ie)return;const n=K(o);if(n){if(i==="text"){Y({x:n.x,y:n.y,show:!0});return}V.current=Le[Math.floor(Math.random()*Le.length)],g(!0),ve(n),D(n),he(0)}},[ie,i,K]),ue=a.useCallback(o=>{if(!M||!ie)return;const n=K(o);n&&D(n)},[M,ie,K]),xe=a.useCallback(()=>{if(!M||!z||!ie)return;const o=ye||z,n=ne(z),d=ne(o);if(!n||!d){console.warn("åº§æ¨™è½‰æ›å¤±æ•—ï¼Œåœ–è¡¨å¯èƒ½æœªæº–å‚™å¥½"),g(!1),ve(null),D(null),te(null),he(0);return}if(i==="parallel"&&me===0){te(o),he(1);return}let l;if(i==="horizontal"||i==="vertical")l=[d];else if(i==="parallel"&&q){const b=ne(q);if(!b){g(!1),ve(null),D(null),te(null),he(0);return}l=[n,b,d]}else l=[n,d];const u={id:Date.now().toString(),type:i,points:l,color:V.current};v(u),g(!1),ve(null),D(null),te(null),he(0)},[M,ie,z,ye,i,q,me,v,ne]),pe=a.useCallback(o=>{var u;if(!J)return;const n=(u=h.current)==null?void 0:u.getBoundingClientRect();if(!n)return;const d={x:o.clientX-n.left,y:o.clientY-n.top},l=y(d);l?(m(l.id),o.stopPropagation(),o.preventDefault()):m(null)},[J,y,m]),oe=a.useCallback(()=>{if(!re.trim()){Y({x:0,y:0,show:!1});return}const o=ne({x:P.x,y:P.y});if(!o){console.warn("æ–‡å­—åº§æ¨™è½‰æ›å¤±æ•—"),Y({x:0,y:0,show:!1}),ge("");return}v({id:Date.now().toString(),type:"text",points:[o],color:Le[Math.floor(Math.random()*Le.length)],text:re}),Y({x:0,y:0,show:!1}),ge("")},[re,P,v,ne]),be=a.useCallback(()=>{c&&(p(c),m(null))},[c,p,m]);return le?e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{zIndex:10},children:e.jsx("canvas",{ref:N,width:t,height:s,className:"absolute inset-0"})}):e.jsxs("div",{ref:h,className:"absolute inset-0",style:{zIndex:10},children:[ie&&e.jsx("canvas",{ref:N,width:t,height:s,className:"absolute inset-0 cursor-crosshair",style:{pointerEvents:"auto"},onMouseDown:Q,onMouseMove:ue,onMouseUp:xe,onMouseLeave:()=>{M&&i!=="parallel"&&xe()}}),J&&e.jsxs(e.Fragment,{children:[e.jsx("canvas",{ref:N,width:t,height:s,className:"absolute inset-0",style:{pointerEvents:"none"}}),e.jsx("div",{className:"absolute inset-0 cursor-pointer",style:{pointerEvents:"auto"},onMouseDown:pe})]}),c&&we&&J&&e.jsxs(A,{variant:"destructive",size:"sm",className:"absolute h-7 px-2 text-xs shadow-lg animate-in fade-in zoom-in duration-150",style:{left:we.x-30,top:we.y-14,pointerEvents:"auto",zIndex:20},onClick:o=>{o.stopPropagation(),be()},children:[e.jsx(Yt,{className:"h-3.5 w-3.5 mr-1"}),"åˆªé™¤"]}),P.show&&e.jsxs("div",{className:"absolute flex items-center gap-1 bg-white dark:bg-gray-800 p-1 rounded shadow-lg border",style:{left:P.x,top:P.y,pointerEvents:"auto",zIndex:30},children:[e.jsx(ps,{value:re,onChange:o=>ge(o.target.value),onKeyDown:o=>{o.key==="Enter"&&oe(),o.key==="Escape"&&Y({x:0,y:0,show:!1})},placeholder:"è¼¸å…¥æ¨™è¨»...",className:"h-7 w-40 text-xs",autoFocus:!0}),e.jsx(A,{size:"sm",className:"h-7 px-2",onClick:oe,children:"ç¢ºå®š"}),e.jsx(A,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0",onClick:()=>Y({x:0,y:0,show:!1}),children:e.jsx(mt,{className:"h-3 w-3"})})]})]})}function Ds(){const[t,s]=a.useState([]),[r,i]=a.useState("off"),[c,v]=a.useState(null),m=a.useCallback(h=>{s(T=>[...T,h])},[]),p=a.useCallback(h=>{s(T=>T.filter(O=>O.id!==h)),v(T=>T===h?null:T)},[]),f=a.useCallback((h,T)=>{s(O=>O.map(E=>E.id===h?{...E,...T}:E))},[]),L=a.useCallback(()=>{s([]),v(null)},[]),N=a.useMemo(()=>t.find(h=>h.id===c)||null,[t,c]);return{drawings:t,activeType:r,setActiveType:i,selectedId:c,setSelectedId:v,selectedDrawing:N,addDrawing:m,deleteDrawing:p,updateDrawing:f,clearDrawings:L}}const Ze={visibleStartDate:null,visibleEndDate:null,loadedStartDate:"2021-01-01",loadedEndDate:new Date().toISOString().split("T")[0],showMA5:!0,showMA10:!0,showMA20:!0,showMA60:!0,showMA120:!1,showBollinger:!1,showVolume:!0,macdParams:{fast:12,slow:26,signal:9},kdParams:{k:9,d:3,smooth:3},rsiParams:{period:14},bollingerParams:{period:20,std:2},zoomLevel:1,currentSymbol:null},Is=Tt()(Bt(t=>({...Ze,setVisibleRange:(s,r)=>t({visibleStartDate:s,visibleEndDate:r}),setLoadedRange:(s,r)=>t({loadedStartDate:s,loadedEndDate:r}),toggleIndicator:s=>t(r=>({[s]:!r[s]})),setZoomLevel:s=>t({zoomLevel:s}),setCurrentSymbol:s=>t({currentSymbol:s}),setMacdParams:s=>t({macdParams:s}),setKdParams:s=>t({kdParams:s}),setRsiParams:s=>t({rsiParams:s}),setBollingerParams:s=>t({bollingerParams:s}),resetSettings:()=>t(Ze)}),{name:"chart-settings",partialize:t=>({showMA5:t.showMA5,showMA10:t.showMA10,showMA20:t.showMA20,showMA60:t.showMA60,showMA120:t.showMA120,showBollinger:t.showBollinger,showVolume:t.showVolume,macdParams:t.macdParams,kdParams:t.kdParams,rsiParams:t.rsiParams,bollingerParams:t.bollingerParams})})),_s=[{label:"1M",days:22,key:"1m"},{label:"3M",days:66,key:"3m"},{label:"6M",days:132,key:"6m"},{label:"1Y",days:252,key:"1y"},{label:"3Y",days:756,key:"3y"},{label:"5Y",days:1260,key:"5y"},{label:"å…¨éƒ¨",days:0,key:"all"}],Os={main:400,volume:120,indicator:200},Vs=a.forwardRef(({data:t,symbol:s,showBollinger:r=!1,isLoading:i=!1,chartHeights:c=Os,onLoadMore:v,onRangeChange:m,onCrosshairMove:p,onChartClick:f},L)=>{var k,C,$,X,W,F,ae,fe,ce,$e,Ae,We,Fe,Ue,Be;const[N,h]=a.useState(null),[T,O]=a.useState("macd"),[E,M]=a.useState("3m"),[g,z]=a.useState(null),{drawings:ve,activeType:ye,setActiveType:D,selectedId:q,setSelectedId:te,addDrawing:me,deleteDrawing:he}=Ds(),[P,Y]=a.useState({width:0,height:0}),re=a.useRef(null);a.useEffect(()=>{if(!re.current)return;const x=new ResizeObserver(w=>{const S=w[0];S&&Y({width:S.contentRect.width,height:S.contentRect.height})});return x.observe(re.current),()=>x.disconnect()},[]);const ge=a.useCallback(x=>{z(x),p&&p(x)},[p]),{showMA5:V,showMA10:se,showMA20:U,showMA60:le,showMA120:J,showBollinger:ie,toggleIndicator:ne,setVisibleRange:de}=Is(),we=r||ie,j=a.useRef(null),Ne=a.useRef(null),I=a.useRef(null),B=a.useRef(null),je=a.useRef(null),[ke,y]=a.useState({chart:null,series:null});a.useImperativeHandle(L,()=>({captureCharts:async x=>{const w=[j.current,I.current,B.current];let S=null;if(j.current){const R=j.current.timeScale().getVisibleLogicalRange();R&&(S={from:R.from,to:R.to})}if(j.current&&t.length>0){const R=x?t.findIndex(H=>H.date===x):t.length-1;if(R>=0){const H=j.current.timeScale().width(),Ke=j.current.timeScale().options().barSpacing||6,Rt=H-50,Ct=Math.ceil(Rt/Ke),Lt=R+1,Mt=Math.max(0,R-Ct+1);w.forEach(Re=>{Re&&(Re.timeScale().applyOptions({barSpacing:Ke,rightOffset:0}),Re.timeScale().setVisibleLogicalRange({from:Mt,to:Lt}))}),await new Promise(Re=>setTimeout(Re,250))}}const _=R=>R?R.takeScreenshot().toDataURL("image/png"):null,G={main:_(j.current)||"",volume:_(I.current)||"",indicator:_(B.current)||""};return S&&(await new Promise(R=>setTimeout(R,50)),w.forEach(R=>{R&&R.timeScale().setVisibleLogicalRange(S)})),G}}));const K=a.useMemo(()=>({ma5:V,ma10:se,ma20:U,ma60:le,ma120:J}),[V,se,U,le,J]),Q=a.useCallback((x,w)=>{const S=x.timeScale(),_=G=>{G&&w.forEach(R=>{R&&R.timeScale().setVisibleLogicalRange(G)})};return S.subscribeVisibleLogicalRangeChange(_),()=>{S.unsubscribeVisibleLogicalRangeChange(_)}},[]),ue=a.useCallback((x,w)=>{j.current=x,Ne.current=w,y({chart:x,series:w}),x.timeScale().subscribeVisibleLogicalRangeChange(S=>{if(!S||!t.length)return;const _=Math.max(0,Math.floor(S.from)),G=Math.min(t.length-1,Math.ceil(S.to));if(t[_]&&t[G]){const R=t[_].date,H=t[G].date;h({from:R,to:H}),de(R,H),m&&m(R,H)}}),I.current&&Q(x,[I.current]),B.current&&Q(x,[B.current])},[t,Q,de,m]),xe=a.useCallback(x=>{if(I.current=x,j.current){Q(x,[j.current]);const w=j.current.timeScale().getVisibleLogicalRange();w&&x.timeScale().setVisibleLogicalRange(w)}},[Q]),pe=a.useCallback(x=>{if(B.current=x,j.current){Q(x,[j.current]);const w=j.current.timeScale().getVisibleLogicalRange();w&&x.timeScale().setVisibleLogicalRange(w)}},[Q]),oe=a.useCallback((x,w)=>{if(!j.current||!t.length)return;M(w);const S=t.length-1,_=x===0?0:Math.max(0,S-x);[j.current,I.current,B.current].forEach(R=>{R&&R.timeScale().setVisibleLogicalRange({from:_,to:S+5})})},[t]),be=a.useCallback(()=>{oe(66,"3m")},[oe]),o=a.useCallback(()=>{if(!j.current)return;const x=j.current.timeScale().getVisibleLogicalRange();if(!x)return;const w=(x.from+x.to)/2,S=(x.to-x.from)*.7,_=w-S/2,G=w+S/2;[j.current,I.current,B.current].forEach(H=>{H&&H.timeScale().setVisibleLogicalRange({from:_,to:G})})},[]),n=a.useCallback(()=>{if(!j.current)return;const x=j.current.timeScale().getVisibleLogicalRange();if(!x)return;const w=(x.from+x.to)/2,S=(x.to-x.from)*1.4,_=Math.max(0,w-S/2),G=Math.min(t.length,w+S/2);[j.current,I.current,B.current].forEach(H=>{H&&H.timeScale().setVisibleLogicalRange({from:_,to:G})})},[t.length]),d=a.useCallback(()=>{if(!j.current)return;const x=j.current.timeScale().getVisibleLogicalRange();if(!x)return;const w=x.to-x.from,S=w*.3,_=Math.max(0,x.from-S),G=_+w;[j.current,I.current,B.current].forEach(H=>{H&&H.timeScale().setVisibleLogicalRange({from:_,to:G})})},[]),l=a.useCallback(()=>{if(!j.current)return;const x=j.current.timeScale().getVisibleLogicalRange();if(!x)return;const w=x.to-x.from,S=w*.3,_=Math.min(t.length+5,x.to+S),G=_-w;[j.current,I.current,B.current].forEach(H=>{H&&H.timeScale().setVisibleLogicalRange({from:G,to:_})})},[t.length]),u=a.useCallback(()=>{if(!j.current||!t.length)return;const x=j.current.timeScale().getVisibleLogicalRange();if(!x)return;const w=x.to-x.from,S=t.length+5,_=S-w;[j.current,I.current,B.current].forEach(R=>{R&&R.timeScale().setVisibleLogicalRange({from:_,to:S})})},[t.length]),b=a.useCallback(()=>{if(!j.current||!t.length)return;const x=j.current.timeScale().getVisibleLogicalRange();if(!x)return;const w=x.to-x.from,S=0,_=w;[j.current,I.current,B.current].forEach(R=>{R&&R.timeScale().setVisibleLogicalRange({from:S,to:_})})},[]);return a.useEffect(()=>{const x=w=>{var S;if(!(!((S=je.current)!=null&&S.contains(document.activeElement))&&document.activeElement!==document.body))switch(w.key){case"ArrowLeft":w.preventDefault(),d();break;case"ArrowRight":w.preventDefault(),l();break;case"+":case"=":w.preventDefault(),o();break;case"-":w.preventDefault(),n();break;case"Home":w.preventDefault(),u();break;case"End":w.preventDefault(),b();break;case"r":case"R":!w.ctrlKey&&!w.metaKey&&(w.preventDefault(),be());break}};return window.addEventListener("keydown",x),()=>window.removeEventListener("keydown",x)},[d,l,o,n,u,b,be]),a.useEffect(()=>{if(j.current&&B.current){const x=j.current.timeScale().getVisibleLogicalRange();x&&setTimeout(()=>{var w;(w=B.current)==null||w.timeScale().setVisibleLogicalRange(x)},50)}},[T]),a.useEffect(()=>{t.length>0&&setTimeout(()=>oe(66,"3m"),100)},[t.length,oe]),!t||t.length===0?e.jsx("div",{className:"flex items-center justify-center h-64 text-muted-foreground",children:i?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5 animate-spin"}),"è¼‰å…¥ä¸­..."]}):"ç„¡è³‡æ–™"}):e.jsxs("div",{ref:je,className:"w-full space-y-2",tabIndex:0,children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 px-2",children:[e.jsx("div",{className:"flex items-center gap-1",children:_s.map(x=>e.jsx(A,{variant:E===x.key?"default":"outline",size:"sm",className:"h-7 px-2 text-xs",onClick:()=>oe(x.days,x.key),children:x.label},x.key))}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:d,title:"â† å¾€å·¦ç§»å‹•",children:e.jsx(ns,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:l,title:"â†’ å¾€å³ç§»å‹•",children:e.jsx(as,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:o,title:"+ æ”¾å¤§",children:e.jsx(rs,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:n,title:"- ç¸®å°",children:e.jsx(ls,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:u,title:"Home: è·³åˆ°æœ€æ–°",children:e.jsx(is,{className:"h-4 w-4"})}),e.jsx(A,{variant:"ghost",size:"icon",className:"h-7 w-7",onClick:be,title:"R: é‡ç½®",children:e.jsx(os,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsx(Ps,{activeType:ye,onTypeChange:D,drawingCount:ve.length})]}),N&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground bg-muted px-2 py-1 rounded",children:[e.jsx(cs,{className:"h-3 w-3"}),e.jsxs("span",{children:[N.from," ~ ",N.to]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs px-2",children:[e.jsxs("span",{children:[e.jsx("span",{className:"inline-block w-3 h-3 mr-1",style:{backgroundColor:"#ef5350"}})," ä¸Šæ¼²"]}),e.jsxs("span",{children:[e.jsx("span",{className:"inline-block w-3 h-3 mr-1",style:{backgroundColor:"#26a69a"}})," ä¸‹è·Œ"]}),e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:V?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:V?"#ffc107":void 0,color:V?"black":"#ffc107"},onClick:()=>ne("showMA5"),children:"MA5"}),V&&((g==null?void 0:g.ma5)??((k=t[t.length-1])==null?void 0:k.ma5))&&e.jsx("span",{className:"font-mono",style:{color:"#ffc107"},children:($=(g==null?void 0:g.ma5)??((C=t[t.length-1])==null?void 0:C.ma5))==null?void 0:$.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:se?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:se?"#9c27b0":void 0,color:se?"white":"#9c27b0"},onClick:()=>ne("showMA10"),children:"MA10"}),se&&((g==null?void 0:g.ma10)??((X=t[t.length-1])==null?void 0:X.ma10))&&e.jsx("span",{className:"font-mono",style:{color:"#9c27b0"},children:(F=(g==null?void 0:g.ma10)??((W=t[t.length-1])==null?void 0:W.ma10))==null?void 0:F.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:U?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:U?"#2196f3":void 0,color:U?"white":"#2196f3"},onClick:()=>ne("showMA20"),children:"MA20"}),U&&((g==null?void 0:g.ma20)??((ae=t[t.length-1])==null?void 0:ae.ma20))&&e.jsx("span",{className:"font-mono",style:{color:"#2196f3"},children:(ce=(g==null?void 0:g.ma20)??((fe=t[t.length-1])==null?void 0:fe.ma20))==null?void 0:ce.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:le?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:le?"#ff9800":void 0,color:le?"black":"#ff9800"},onClick:()=>ne("showMA60"),children:"MA60"}),le&&((g==null?void 0:g.ma60)??(($e=t[t.length-1])==null?void 0:$e.ma60))&&e.jsx("span",{className:"font-mono",style:{color:"#ff9800"},children:(We=(g==null?void 0:g.ma60)??((Ae=t[t.length-1])==null?void 0:Ae.ma60))==null?void 0:We.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx(A,{variant:J?"default":"ghost",size:"sm",className:"h-5 px-1.5 text-xs",style:{backgroundColor:J?"#9e9e9e":void 0,color:J?"black":"#9e9e9e"},onClick:()=>ne("showMA120"),children:"MA120"}),J&&((g==null?void 0:g.ma120)??((Fe=t[t.length-1])==null?void 0:Fe.ma120))&&e.jsx("span",{className:"font-mono",style:{color:"#9e9e9e"},children:(Be=(g==null?void 0:g.ma120)??((Ue=t[t.length-1])==null?void 0:Ue.ma120))==null?void 0:Be.toFixed(2)})]}),we&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-px h-4 bg-border mx-1"}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#e91e63"},children:"- -"})," å¸ƒæ—ä¸Šè»Œ"]}),e.jsxs("span",{children:[e.jsx("span",{style:{color:"#4caf50"},children:"- -"})," å¸ƒæ—ä¸‹è»Œ"]})]})]}),e.jsxs("div",{ref:re,className:"border rounded-lg overflow-hidden relative transition-all duration-300 ease-in-out",style:{height:c.main},children:[i&&e.jsx("div",{className:"absolute inset-0 bg-background/50 flex items-center justify-center z-10",children:e.jsx(Oe,{className:"h-6 w-6 animate-spin"})}),e.jsx(Cs,{data:t,height:c.main,showBollinger:we,visibleMAs:K,onChartReady:ue,onCrosshairMove:ge,onChartClick:f}),P.width>0&&e.jsx(Es,{width:P.width,height:P.height,drawings:ve,activeType:ye,selectedId:q,onAddDrawing:me,onSelectDrawing:te,onDeleteDrawing:he,chart:ke.chart,mainSeries:ke.series})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden transition-all duration-300 ease-in-out",style:{height:c.volume+28},children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 text-xs text-muted-foreground border-b",children:[e.jsx("span",{children:"æˆäº¤é‡"}),e.jsxs("span",{className:"ml-2",children:[e.jsx("span",{className:"text-red-500",children:"â—"})," ä¸Šæ¼²",e.jsx("span",{className:"text-green-500 ml-2",children:"â—"})," ä¸‹è·Œ",e.jsx("span",{className:"ml-2",style:{color:"#ff9800"},children:"- -"})," 5æ—¥å‡é‡"]})]}),e.jsx(Ts,{data:t,height:c.volume,onChartReady:xe})]}),e.jsxs(Ss,{value:T,onValueChange:O,className:"w-full",children:[e.jsxs(St,{className:"grid w-full grid-cols-4",children:[e.jsxs(Me,{value:"macd",className:"flex items-center gap-1",children:[e.jsx(ds,{className:"h-3 w-3"}),"MACD"]}),e.jsxs(Me,{value:"kd",className:"flex items-center gap-1",children:[e.jsx(gt,{className:"h-3 w-3"}),"KD"]}),e.jsxs(Me,{value:"rsi",className:"flex items-center gap-1",children:[e.jsx(Ve,{className:"h-3 w-3"}),"RSI"]}),e.jsx(Me,{value:"all",children:"å…¨éƒ¨"})]}),e.jsx(Te,{value:"macd",className:"border rounded-lg overflow-hidden mt-2",children:e.jsx(Ge,{data:t,height:c.indicator,onChartReady:pe})}),e.jsx(Te,{value:"kd",className:"border rounded-lg overflow-hidden mt-2",children:e.jsx(Ye,{data:t,height:c.indicator,onChartReady:pe})}),e.jsx(Te,{value:"rsi",className:"border rounded-lg overflow-hidden mt-2",children:e.jsx(Xe,{data:t,height:c.indicator,onChartReady:pe})}),e.jsxs(Te,{value:"all",className:"space-y-2 mt-2",children:[e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx(Ge,{data:t,height:150,onChartReady:pe})}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx(Ye,{data:t,height:150})}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx(Xe,{data:t,height:140})})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground text-center py-2",children:"ğŸ’¡ æ‹–æ›³ç§»å‹• | æ»¾è¼ªç¸®æ”¾ | â†â†’ æ–¹å‘éµç§»å‹• | +/- ç¸®æ”¾ | Home è·³åˆ°æœ€æ–° | R é‡ç½®"})]})}),ee=zt.create({baseURL:"/api",timeout:12e4});ee.interceptors.response.use(t=>t,t=>{var r,i,c,v,m,p,f;const s=((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.detail)||((v=(c=t.response)==null?void 0:c.data)==null?void 0:v.error)||t.message||"è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";return t.code==="ECONNABORTED"?console.error("API è«‹æ±‚è¶…æ™‚:",(m=t.config)==null?void 0:m.url):((p=t.response)==null?void 0:p.status)===400?console.warn("API è«‹æ±‚åƒæ•¸éŒ¯èª¤:",s):((f=t.response)==null?void 0:f.status)>=500&&console.error("ä¼ºæœå™¨éŒ¯èª¤:",s),Promise.reject(new Error(s))});async function Zs(t){const s=new URLSearchParams;Object.entries(t).forEach(([i,c])=>{c!=null&&(Array.isArray(c)?s.set(i,c.join(",")):s.set(i,String(c)))});const{data:r}=await ee.get(`/stocks/filter?${s}`);if(!r.data)throw new Error("API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘ data æ¬„ä½");return r.data}async function Js(){const{data:t}=await ee.get("/trading-date");if(!t.data)throw new Error("API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘ data æ¬„ä½");return t.data}async function Qs(t,s){const r=new URLSearchParams;t&&r.set("date",t);const{data:i}=await ee.get(`/turnover/limit-up?${r}`);return i}async function en(t){const s=t?`?date=${t}`:"",{data:r}=await ee.get(`/turnover/top20${s}`);return r}async function tn(t){const s=t?`?date=${t}`:"",{data:r}=await ee.get(`/turnover/top20-limit-up${s}`);return r}async function sn(t,s){const r=new URLSearchParams;t&&r.set("start_date",t),s&&r.set("end_date",s);const{data:i}=await ee.get(`/turnover/top200-limit-up?${r}`);return i}async function nn(t,s,r,i){const c=new URLSearchParams;t&&c.set("start_date",t),s&&c.set("end_date",s),r!==void 0&&c.set("change_min",String(r)),i!==void 0&&c.set("change_max",String(i));const{data:v}=await ee.get(`/turnover/top200-change-range?${c}`);return v}async function an(t,s){const r=new URLSearchParams;t&&r.set("start_date",t),s&&r.set("end_date",s);const{data:i}=await ee.get(`/turnover/top200-5day-high?${r}`);return i}async function rn(t,s){const r=new URLSearchParams;t&&r.set("start_date",t),s&&r.set("end_date",s);const{data:i}=await ee.get(`/turnover/top200-5day-low?${r}`);return i}async function ln(t,s,r,i){const c=new URLSearchParams;t&&c.set("start_date",t),s&&c.set("end_date",s),r!==void 0&&c.set("min_change",String(r)),i!==void 0&&c.set("max_change",String(i));const{data:v}=await ee.get(`/turnover/ma-breakout?${c}`);return v}async function on(t,s,r){const i=new URLSearchParams;t&&i.set("start_date",t),s&&i.set("end_date",s),r!==void 0&&i.set("volume_ratio",String(r));const{data:c}=await ee.get(`/turnover/volume-surge?${i}`);return c}async function cn(t,s,r){const i=new URLSearchParams;t&&i.set("start_date",t),s&&i.set("end_date",s),r!==void 0&&i.set("min_days",String(r));const{data:c}=await ee.get(`/turnover/institutional-buy?${i}`);return c}async function dn(t,s,r,i,c,v,m,p,f,L,N){const h=new URLSearchParams;t&&h.set("start_date",t),s&&h.set("end_date",s),r!==void 0&&h.set("turnover_min",String(r)),i!==void 0&&h.set("turnover_max",String(i)),c!==void 0&&h.set("change_min",String(c)),v!==void 0&&h.set("change_max",String(v)),m!==void 0&&h.set("min_buy_days",String(m)),p!==void 0&&h.set("volume_ratio",String(p)),f!==void 0&&h.set("is_5day_high",String(f)),L!==void 0&&h.set("is_5day_low",String(L)),N!==void 0&&h.set("is_ma20_uptrend",String(N));const{data:T}=await ee.get(`/turnover/combo-filter?${h}`);return T}function Je(t){if(t==null)return'""';const s=String(t);return s.includes('"')||s.includes(",")||s.includes(`
`)||s.includes("\r")?`"${s.replace(/"/g,'""')}"`:`"${s}"`}function un(t,s,r){let i,c,v;if(t==="csv"){const L=Object.keys(s[0]||{}).join(","),N=s.map(h=>Object.values(h).map(T=>Je(T)).join(","));i=[L,...N].join(`
`),c="text/csv",v="csv"}else if(t==="json")i=JSON.stringify(s,null,2),c="application/json",v="json";else{const L=Object.keys(s[0]||{}).join(","),N=s.map(h=>Object.values(h).map(T=>Je(T)).join(","));i=[L,...N].join(`
`),c="application/vnd.ms-excel",v="xls"}const m=new Blob(["\uFEFF"+i],{type:`${c};charset=utf-8`}),p=URL.createObjectURL(m),f=document.createElement("a");f.href=p,f.download=`${r}.${v}`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(p)}async function $s(t,s="day",r=5,i=!1){let c,v;typeof t=="string"?(v=t,c=new URLSearchParams,c.set("period",s),c.set("years",r.toString()),i&&c.set("force_refresh","true")):(v=t.symbol,c=new URLSearchParams,c.set("period",t.period||"day"),t.startDate&&c.set("start_date",t.startDate),t.endDate&&c.set("end_date",t.endDate),!t.startDate&&!t.endDate&&c.set("years",(t.years||5).toString()),t.forceRefresh&&c.set("force_refresh","true"));const{data:m}=await ee.get(`/stocks/${v}/kline?${c}`);if(!m.data)throw new Error("API å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘ K ç·šè³‡æ–™");return m.data}const As=[{value:"day",label:"æ—¥K"},{value:"week",label:"é€±K"},{value:"month",label:"æœˆK"}],Ws={normal:{main:350,volume:100,indicator:180,dialogWidth:"max-w-5xl"},large:{main:500,volume:130,indicator:220,dialogWidth:"max-w-6xl"},xlarge:{main:650,volume:160,indicator:280,dialogWidth:"max-w-[95vw]"}},Fs=5;function fn({open:t,onClose:s,symbol:r,name:i}){var I,B,je,ke;const[c,v]=a.useState("day"),[m,p]=a.useState(!1),[f]=a.useState("xlarge"),[L,N]=a.useState(0),[h,T]=a.useState(null),[O,E]=a.useState(null),[M,g]=a.useState(!1),z=a.useRef(null),ve=a.useCallback(y=>{M||T(y)},[M]),ye=a.useCallback(()=>{M?(g(!1),E(null)):(g(!0),E(h))},[M,h]);a.useEffect(()=>{t&&r&&(N(0),g(!1),E(null))},[t,r]);const{data:D,isLoading:q,error:te,refetch:me,isFetching:he}=Pt({queryKey:["kline-5year",r,c,L],queryFn:async()=>await $s({symbol:r,period:c,years:Fs,forceRefresh:m}),enabled:t&&!!r,staleTime:m?0:600*1e3,gcTime:1800*1e3,retry:3,retryDelay:y=>Math.min(1e3*2**y,3e4),refetchOnWindowFocus:!1});a.useEffect(()=>{D&&m&&p(!1)},[D,m]);const P=(D==null?void 0:D.kline_data)||[],Y=D==null?void 0:D.latest_price,re=(D==null?void 0:D.name)||i||r,ge=D==null?void 0:D.industry,V=D==null?void 0:D.data_range,se=(D==null?void 0:D.data_count)||0,U=a.useMemo(()=>{const y=M?O:h;if(y&&y.close!=null){const Q=P.findIndex(be=>be.date===y.date),ue=Q>0?P[Q-1].close:null,xe=ue!=null&&y.close!=null?y.close-ue:null,pe=ue!=null&&ue!==0&&xe!=null?xe/ue*100:null,oe=y.close!=null&&y.volume?y.close*y.volume/1e8:null;return{open:y.open,high:y.high,low:y.low,close:y.close,change:xe,changePct:pe,volume:y.volume,amount:oe,date:y.date}}const K=P.length>0?P[P.length-1]:null;return Y?{open:(K==null?void 0:K.open)??null,high:(K==null?void 0:K.high)??null,low:(K==null?void 0:K.low)??null,close:Y.close,change:Y.change,changePct:Y.change_pct,volume:Y.volume,amount:Y.amount,date:null}:null},[M,O,h,Y,P]),le=((U==null?void 0:U.change)||0)>=0,J=le?"text-red-500":"text-green-600",ie=le?Ve:hs,ne=a.useCallback(async()=>{var y,K,Q,ue,xe,pe,oe,be,o;if(!(!z.current||!r))try{const n=M?O:h,d=(n==null?void 0:n.date)||(P.length>0?P[P.length-1].date:null),l=d?P.findIndex(ae=>ae.date===d):P.length-1,u=l>=0?P[l]:null,b=l>0?P[l-1]:null,k=u!=null&&u.close&&(b!=null&&b.close)?u.close-b.close:null,C=k!==null&&(b!=null&&b.close)?k/b.close*100:null,$=(k??0)>=0,X=await z.current.captureCharts(d||void 0),W=c==="day"?"æ—¥Kç·š":c==="week"?"é€±Kç·š":"æœˆKç·š",F=window.open("","_blank","width=1123,height=794");F&&(F.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${r} ${re} ${W}</title>
                        <style>
                            @page { size: A4 landscape; margin: 6mm; }
                            * { box-sizing: border-box; margin: 0; padding: 0; }
                            html, body {
                                width: 285mm;
                                height: 198mm;
                                overflow: hidden;
                            }
                            body {
                                font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                                background: #fff;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .container {
                                width: 285mm;
                                height: 198mm;
                                display: grid;
                                grid-template-columns: 225mm 58mm;
                                grid-template-rows: auto 1fr auto;
                                gap: 2mm;
                                padding: 1mm;
                            }
                            /* æ¨™é¡Œæ©«è·¨å…©æ¬„ */
                            .header {
                                grid-column: 1 / -1;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 1mm 0;
                                border-bottom: 2px solid #1e293b;
                                margin-bottom: 2mm;
                            }
                            .title-group { display: flex; align-items: baseline; gap: 12px; }
                            .symbol {
                                font-size: 26px; font-weight: 900; color: #0f172a;
                                background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                                -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                            }
                            .name { font-size: 18px; font-weight: bold; color: #334155; }
                            .industry-tag {
                                font-size: 11px; background: #f1f5f9; color: #475569;
                                padding: 2px 8px; border-radius: 4px;
                            }
                            .period-tag {
                                font-size: 12px; background: #3b82f6; color: white;
                                padding: 3px 12px; border-radius: 4px; font-weight: 600;
                            }
                            .date-info { font-size: 11px; color: #64748b; }

                            /* å·¦å´åœ–è¡¨å€ */
                            .charts-area {
                                display: flex;
                                flex-direction: column;
                                gap: 1mm;
                            }
                            .chart-box {
                                background: white;
                                border: 1px solid #e2e8f0;
                                border-radius: 2px;
                                padding: 0;
                                overflow: hidden;
                            }
                            .chart-title {
                                font-size: 8px; color: #475569; font-weight: 700;
                                position: absolute;
                                top: 0; left: 0;
                                padding: 2px 6px;
                                background: rgba(255,255,255,0.9);
                                backdrop-filter: blur(2px);
                                z-index: 10;
                                border-bottom-right-radius: 4px;
                                border-right: 1px solid #e2e8f0;
                                border-bottom: 1px solid #e2e8f0;
                            }
                            .chart-main { height: 100mm; position: relative; }
                            .chart-volume { height: 30mm; position: relative; }
                            .chart-indicator { height: 35mm; position: relative; }
                            .chart-image {
                                width: 100%;
                                height: 100%;
                                object-fit: contain;
                                object-position: left center;
                            }

                            /* å³å´è³‡è¨Šé¢æ¿ */
                            .info-panel {
                                display: flex;
                                flex-direction: column;
                                gap: 1.5mm;
                            }
                            .info-card {
                                background: #f8fafc;
                                border: 1px solid #e2e8f0;
                                border-radius: 6px;
                                padding: 3mm;
                            }
                            .info-card-title {
                                font-size: 10px; font-weight: 700; color: #334155;
                                margin-bottom: 2mm; padding-bottom: 1mm;
                                border-bottom: 1px solid #e2e8f0;
                                text-transform: uppercase; letter-spacing: 0.5px;
                            }
                            .price-row {
                                display: flex; justify-content: space-between;
                                padding: 1.5mm 0; border-bottom: 1px dashed #e5e7eb;
                            }
                            .price-row:last-child { border-bottom: none; }
                            .price-label { font-size: 10px; color: #64748b; }
                            .price-value { font-size: 12px; font-weight: 700; }
                            .up { color: #dc2626; }
                            .down { color: #16a34a; }

                            .ma-row {
                                display: flex; justify-content: space-between; align-items: center;
                                padding: 1.5mm 0;
                            }
                            .ma-label {
                                font-size: 10px; font-weight: 600;
                                display: flex; align-items: center; gap: 4px;
                            }
                            .ma-dot {
                                width: 8px; height: 8px; border-radius: 50%;
                            }
                            .ma-value { font-size: 11px; font-weight: 700; }

                            .legend-section {
                                background: #fefce8;
                                border: 1px solid #fef08a;
                            }
                            .legend-grid {
                                display: grid; grid-template-columns: 1fr 1fr; gap: 2mm;
                            }
                            .legend-item {
                                display: flex; align-items: center; gap: 4px;
                                font-size: 9px; color: #475569;
                            }
                            .legend-box { width: 12px; height: 12px; border-radius: 2px; }

                            .data-range-card {
                                background: #f0f9ff;
                                border: 1px solid #bae6fd;
                            }
                            .range-text { font-size: 10px; color: #0369a1; line-height: 1.6; }

                            /* é å°¾æ©«è·¨å…©æ¬„ */
                            .footer {
                                grid-column: 1 / -1;
                                display: flex;
                                justify-content: space-between;
                                padding-top: 2mm;
                                border-top: 1px solid #e2e8f0;
                                font-size: 9px;
                                color: #94a3b8;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <!-- æ¨™é¡Œåˆ— -->
                            <div class="header">
                                <div class="title-group">
                                    <span class="symbol">${r}</span>
                                    <span class="name">${re}</span>
                                    ${ge?`<span class="industry-tag">${ge}</span>`:""}
                                    <span class="period-tag">${W}</span>
                                </div>
                                <div class="date-info">
                                    <strong>è³‡æ–™æ—¥æœŸ</strong> ${(u==null?void 0:u.date)||"-"}
                                </div>
                            </div>

                            <!-- å·¦å´ï¼šåœ–è¡¨å€ -->
                            <div class="charts-area">
                                <div class="chart-box chart-main">
                                    <div class="chart-title">Kç·šèµ°å‹¢åœ–</div>
                                    <img src="${X.main}" class="chart-image" />
                                </div>
                                <div class="chart-box chart-volume">
                                    <div class="chart-title">æˆäº¤é‡</div>
                                    <img src="${X.volume}" class="chart-image" />
                                </div>
                                <div class="chart-box chart-indicator">
                                    <div class="chart-title">æŠ€è¡“æŒ‡æ¨™ (KD / MACD)</div>
                                    <img src="${X.indicator}" class="chart-image" />
                                </div>
                            </div>

                            <!-- å³å´ï¼šè³‡è¨Šé¢æ¿ -->
                            <div class="info-panel">
                                <!-- åƒ¹æ ¼è³‡è¨Š -->
                                <div class="info-card">
                                    <div class="info-card-title">ç•¶æ—¥åƒ¹æ ¼</div>
                                    <div class="price-row">
                                        <span class="price-label">é–‹ç›¤åƒ¹</span>
                                        <span class="price-value">${((y=u==null?void 0:u.open)==null?void 0:y.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-label">æœ€é«˜åƒ¹</span>
                                        <span class="price-value up">${((K=u==null?void 0:u.high)==null?void 0:K.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-label">æœ€ä½åƒ¹</span>
                                        <span class="price-value down">${((Q=u==null?void 0:u.low)==null?void 0:Q.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-label">æ”¶ç›¤åƒ¹</span>
                                        <span class="price-value ${$?"up":"down"}" style="font-size:14px;">${((ue=u==null?void 0:u.close)==null?void 0:ue.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="price-row" style="background:#f8fafc; margin:1mm -2mm -2mm; padding:2mm; border-radius:0 0 4px 4px;">
                                        <span class="price-label" style="font-weight:600;">æ¼²è·Œå¹…</span>
                                        <span class="price-value ${$?"up":"down"}" style="font-size:15px;">
                                            ${C!==null?($?"â–² +":"â–¼ ")+C.toFixed(2)+"%":"-"}
                                        </span>
                                    </div>
                                </div>

                                <!-- å‡ç·šè³‡è¨Š -->
                                <div class="info-card">
                                    <div class="info-card-title">ç§»å‹•å¹³å‡ç·š</div>
                                    <div class="ma-row">
                                        <span class="ma-label"><span class="ma-dot" style="background:#ffc107"></span>MA5</span>
                                        <span class="ma-value" style="color:#b38600">${((xe=u==null?void 0:u.ma5)==null?void 0:xe.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="ma-row">
                                        <span class="ma-label"><span class="ma-dot" style="background:#9c27b0"></span>MA10</span>
                                        <span class="ma-value" style="color:#7b1fa2">${((pe=u==null?void 0:u.ma10)==null?void 0:pe.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="ma-row">
                                        <span class="ma-label"><span class="ma-dot" style="background:#2196f3"></span>MA20</span>
                                        <span class="ma-value" style="color:#1565c0">${((oe=u==null?void 0:u.ma20)==null?void 0:oe.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="ma-row">
                                        <span class="ma-label"><span class="ma-dot" style="background:#ff9800"></span>MA60</span>
                                        <span class="ma-value" style="color:#e65100">${((be=u==null?void 0:u.ma60)==null?void 0:be.toFixed(2))??"-"}</span>
                                    </div>
                                    <div class="ma-row">
                                        <span class="ma-label"><span class="ma-dot" style="background:#607d8b"></span>MA120</span>
                                        <span class="ma-value" style="color:#455a64">${((o=u==null?void 0:u.ma120)==null?void 0:o.toFixed(2))??"-"}</span>
                                    </div>
                                </div>

                                <!-- åœ–ä¾‹èªªæ˜ -->
                                <div class="info-card legend-section">
                                    <div class="info-card-title">åœ–ä¾‹èªªæ˜</div>
                                    <div class="legend-grid">
                                        <div class="legend-item">
                                            <span class="legend-box" style="background:#ef5350"></span>
                                            <span>ä¸Šæ¼² (ç´…K)</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-box" style="background:#26a69a"></span>
                                            <span>ä¸‹è·Œ (ç¶ K)</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-box" style="background:#ffc107"></span>
                                            <span>MA5 (5æ—¥å‡)</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-box" style="background:#9c27b0"></span>
                                            <span>MA10 (10æ—¥å‡)</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-box" style="background:#2196f3"></span>
                                            <span>MA20 (æœˆç·š)</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-box" style="background:#ff9800"></span>
                                            <span>MA60 (å­£ç·š)</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- è³‡æ–™ç¯„åœ -->
                                <div class="info-card data-range-card">
                                    <div class="info-card-title">è³‡æ–™ç¯„åœ</div>
                                    <div class="range-text">
                                        <div><strong>èµ·å§‹ï¼š</strong>${(V==null?void 0:V.first_date)||"-"}</div>
                                        <div><strong>çµæŸï¼š</strong>${(V==null?void 0:V.last_date)||"-"}</div>
                                        <div><strong>ç­†æ•¸ï¼š</strong>${se.toLocaleString()} ç­†</div>
                                    </div>
                                </div>
                            </div>

                            <!-- é å°¾ -->
                            <div class="footer">
                                <span>è³‡æ–™ä¾†æºï¼šTWSE / FinMindï½œè²“æ˜Ÿäººè³ºå¤§éŒ¢ç³»çµ±</span>
                                <span>åˆ—å°æ™‚é–“ï¼š${new Date().toLocaleString("zh-TW")}</span>
                            </div>
                        </div>
                    </body>
                    </html>
                `),F.document.close(),F.onload=()=>{setTimeout(()=>{F.focus(),F.print()},500)})}catch(n){console.error("åˆ—å°å¤±æ•—:",n),alert("åˆ—å°æº–å‚™å¤±æ•—ï¼Œè«‹é‡è©¦")}},[r,re,ge,V,se,P,M,O,h,c]),de=a.useCallback(()=>{p(!0),N(y=>y+1),me()},[me]),we=a.useCallback(()=>{N(y=>y+1),me()},[me]),j=a.useMemo(()=>Ws[f],[f]),Ne=a.useMemo(()=>{if(!te)return null;const y=te instanceof Error?te.message:"ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤";return y.includes("timeout")?"è«‹æ±‚è¶…æ™‚ï¼Œå·²è‡ªå‹•é‡è©¦":y.includes("402")?"API é¡åº¦å·²ç”¨å®Œï¼Œè«‹ç¨å€™å†è©¦":y},[te]);return e.jsx(bs,{open:t,onOpenChange:y=>!y&&s(),children:e.jsxs(pt,{className:`${j.dialogWidth} max-h-[95vh] overflow-y-auto transition-all duration-300 ease-in-out`,onOpenAutoFocus:y=>y.preventDefault(),children:[e.jsx(bt,{className:"no-print",children:e.jsxs(vt,{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pr-8",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-lg bg-blue-100 dark:bg-blue-900 px-2 py-0.5 rounded",children:r}),e.jsx("span",{className:"text-xl font-bold",children:re}),ge&&e.jsx("span",{className:"text-sm text-muted-foreground px-2 py-0.5 bg-muted rounded",children:ge})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs(ws,{value:c,onValueChange:y=>v(y),children:[e.jsx(yt,{className:"w-18 h-7 text-xs",children:e.jsx(js,{})}),e.jsx(Nt,{children:As.map(y=>e.jsx(kt,{value:y.value,children:y.label},y.value))})]}),e.jsxs(A,{variant:"outline",size:"sm",onClick:ne,className:"h-7 text-xs",disabled:q||P.length===0,children:[e.jsx(us,{className:"h-3.5 w-3.5 mr-1"}),"åˆ—å°"]}),e.jsxs(A,{variant:M?"default":"outline",size:"sm",onClick:ye,className:`h-7 text-xs ${M?"bg-amber-500 hover:bg-amber-600":""}`,disabled:q||P.length===0,children:[M?e.jsx(fs,{className:"h-3.5 w-3.5 mr-1"}):e.jsx(ms,{className:"h-3.5 w-3.5 mr-1"}),M?`å·²é–å®š ${(O==null?void 0:O.date)||""}`:"é–å®š"]}),e.jsx(A,{variant:"ghost",size:"icon",onClick:de,className:"h-7 w-7",disabled:q||he,children:e.jsx(qe,{className:`h-4 w-4 ${q||he?"animate-spin":""}`})})]})]})}),U&&e.jsxs("div",{className:"grid grid-cols-6 gap-2 p-2 bg-gradient-to-r from-slate-50 to-blue-50 dark:from-slate-800 dark:to-blue-900 rounded-lg text-sm mb-2",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"é–‹ç›¤åƒ¹"}),e.jsx("div",{className:"text-base font-bold",children:((I=U.open)==null?void 0:I.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æ”¶ç›¤åƒ¹"}),e.jsx("div",{className:`text-base font-bold ${J}`,children:((B=U.close)==null?void 0:B.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æœ€é«˜åƒ¹"}),e.jsx("div",{className:"text-base font-bold text-red-500",children:((je=U.high)==null?void 0:je.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æœ€ä½åƒ¹"}),e.jsx("div",{className:"text-base font-bold text-green-600",children:((ke=U.low)==null?void 0:ke.toFixed(2))??"-"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æ¼²è·Œå¹…"}),e.jsxs("div",{className:`text-base font-bold flex items-center justify-center ${J}`,children:[e.jsx(ie,{className:"h-3 w-3 mr-0.5"}),U.changePct!=null?`${le?"+":""}${U.changePct.toFixed(2)}%`:"-"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"æˆäº¤é‡"}),e.jsx("div",{className:"text-base font-bold text-sky-500",children:U.volume!=null?U.volume.toLocaleString():"-"})]})]}),V&&e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground px-1 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(gs,{className:"h-3 w-3"}),V.first_date," ~ ",V.last_date," (",se.toLocaleString(),"ç­†)"]}),se>=1e3&&e.jsx("span",{className:"text-green-600",children:"âœ“ 5å¹´å®Œæ•´"})]}),e.jsxs("div",{children:[q&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx(Oe,{className:"h-10 w-10 animate-spin text-primary"}),e.jsx("p",{className:"mt-3 text-muted-foreground",children:"è¼‰å…¥ 5 å¹´è³‡æ–™ä¸­..."}),e.jsx("p",{className:"text-xs text-muted-foreground/60",children:"é¦–æ¬¡ç´„éœ€ 30-60 ç§’"})]}),te&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20",children:[e.jsx(xs,{className:"h-10 w-10 text-amber-500 mb-2"}),e.jsx("p",{className:"text-amber-600 font-medium",children:"è¼‰å…¥å¤±æ•—"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:Ne}),e.jsxs(A,{variant:"outline",onClick:we,className:"mt-3",children:[e.jsx(qe,{className:"h-4 w-4 mr-1"}),"é‡è©¦"]})]}),!q&&!te&&P.length>0&&e.jsx(Vs,{ref:z,data:P,symbol:r||"",isLoading:he,chartHeights:j,onCrosshairMove:ve,onChartClick:y=>{g(!0),E(y)}}),!q&&!te&&P.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-muted-foreground",children:[e.jsx(gt,{className:"h-10 w-10 mb-2"}),e.jsx("p",{children:"ç„¡æ³•å–å¾—è³‡æ–™"}),e.jsx(A,{variant:"outline",onClick:we,className:"mt-3",children:"é‡è©¦"})]})]})]})})}export{fn as S,Ss as T,Qs as a,en as b,tn as c,un as d,sn as e,Zs as f,Js as g,nn as h,an as i,rn as j,ln as k,on as l,cn as m,dn as n,St as o,Me as p,Te as q};
